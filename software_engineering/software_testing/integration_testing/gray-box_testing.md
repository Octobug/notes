# Gray-box testing

> <https://en.wikipedia.org/wiki/Gray-box_testing>

- [Gray-box testing](#gray-box-testing)
  - [基本概念](#基本概念)
    - [黑盒测试](#黑盒测试)
    - [白盒测试](#白盒测试)
    - [灰盒测试 Grey Box Testing](#灰盒测试-grey-box-testing)
    - [“灰盒测试”与“黑盒测试”的区别](#灰盒测试与黑盒测试的区别)
    - [“灰盒测试”与“白盒测试”的区别](#灰盒测试与白盒测试的区别)
    - [“灰盒测试”与“单元测试”的区别](#灰盒测试与单元测试的区别)
    - [灰盒测试相对于黑盒测试的优点](#灰盒测试相对于黑盒测试的优点)
      - [测试可以及早介入](#测试可以及早介入)
      - [有助于测试人员理解系统结构](#有助于测试人员理解系统结构)
      - [可以构造更好的测试用例](#可以构造更好的测试用例)
    - [灰盒测试相对于白盒测试的好处](#灰盒测试相对于白盒测试的好处)
    - [灰盒测试的其他优点](#灰盒测试的其他优点)
    - [灰盒测试的缺点](#灰盒测试的缺点)
  - [如何开展](#如何开展)
    - [观念上的改变](#观念上的改变)
    - [设计上的改变](#设计上的改变)
      - [例子：动态库接口](#例子动态库接口)
      - [例子：Web 接口](#例子web-接口)
    - [文档上的改变](#文档上的改变)
    - [测试团队的改变](#测试团队的改变)
  - [模块接口类型概述](#模块接口类型概述)
    - [接口分类](#接口分类)
    - [测试跨主机的模块接口](#测试跨主机的模块接口)
      - [基于 Web 接口的交互（HTTP 协议）](#基于-web-接口的交互http-协议)
      - [基于数据库的交互](#基于数据库的交互)
      - [基于网络文件系统的交互（NFS）](#基于网络文件系统的交互nfs)
      - [基于其它应用层协议的交互](#基于其它应用层协议的交互)
      - [基于 Socket 的交互](#基于-socket-的交互)

## 基本概念

### 黑盒测试

黑盒测试不关注软件内部的实现细节。它仅仅把被测试的软件当成一个整体处理，只关注软件的外在表现。

### 白盒测试

白盒测试与黑盒测试相反，重点关注软件内部的实现细节（比如代码覆盖率等）。

### 灰盒测试 Grey Box Testing

单纯从名称上来看，灰盒测试是介于黑盒测试与白盒测试之间的一种测试方式。
这种测试方式主要用于多模块构成的稍微复杂的软件系统。

在灰盒测试中，重点关注软件系统内部模块的边界（接口）。

- 对于进程内的模块，其接口可能是动态库的导出函数；
- 对于进程级的模块，其接口可能是各种 IPC（进程间通讯）机制；
- 对于涉及数据库的软件系统，其接口可能是数据库的表结构；
- ……

### “灰盒测试”与“黑盒测试”的区别

- 使用黑盒测试时，只要关心整个软件系统的边界，无需关心软件系统内部各个模块之间如何协作。
- 使用灰盒测试，就需要关心模块与模块之间的交互。

### “灰盒测试”与“白盒测试”的区别

- 在灰盒测试中，无需关心模块内部的实现细节，灰盒测试依然把模块内部当成一个黑盒来看待。
- 白盒测试需要再深入地了解内部模块的实现细节。

### “灰盒测试”与“单元测试”的区别

在进行单元测试前，需要先写一些测试代码（桩代码，stub）。
一般来说，测试代码和被测试代码之间的耦合很紧密。
因此，单元测试通常由开发人员完成。

其次，单元测试的颗粒度会更细，会细到模块内部的类、函数；而灰盒测试仅仅到模块。

### 灰盒测试相对于黑盒测试的优点

#### 测试可以及早介入

- 由于黑盒测试把整个软件系统当成一个整体来测试，如果系统的某个关键模块还没完工，测试人员就无法对整个系统进行测试。
- 灰盒测试是针对模块的边界进行，模块开发完一个就测试一个。

#### 有助于测试人员理解系统结构

- 为了进行灰盒测试，测试人员要熟悉模块之间的协作机制。这有助于测试人员发现系统结构方面的 Bug。
- 对于黑盒测试来说，测试人员不清楚软件系统的内部结构，难以发现一些结构性缺陷。

#### 可以构造更好的测试用例

- 仅用黑盒测试系统的外部边界，有很多软件缺陷是不容易发现的。
- 灰盒测试更能发现模块接口的问题。

### 灰盒测试相对于白盒测试的好处

白盒测试成本高：

- 招聘成本
- 培训成本
- 人力成本

### 灰盒测试的其他优点

- 强化开发文档
- 有助于推进“自动化测试”

### 灰盒测试的缺点

- 不适用于简单的系统
- 对测试人员的要求比黑盒测试高
- 不如白盒测试深入

## 如何开展

### 观念上的改变

很多开发人员和测试人员误认为黑盒测试就是测试的全部。在管理上，要通过各种方式，首先改变这种错误的观念，让开发人员和测试人员都注重内部模块的协同问题。

### 设计上的改变

大部分开发人员在设计内部模块接口时，往往只考虑开发上的便利，而不考虑测试上的便利。

#### 例子：动态库接口

用 C++ 开发一个动态库时，动态库的导出函数有两种风格：

- C++ 风格
- 纯 C 风格 (extern "C")

从“可测试性”角度看，纯 C 风格的函数接口更方便测试。

#### 例子：Web 接口

Web 接口也有两种常见的风格：

- REST
- SOAP

从“可测试性”角度看，REST 更简单、更可读。

### 文档上的改变

灰盒测试侧重于内部模块的接口测试，因此接口文档很重要。

接口文档是开发人员之间的约定，也是开发人员与灰盒测试人员之间的约定。

- 内容：内容一定要简洁、实用，确保测试人员能看懂
- 完成时间：在内部模块编码之前，先让开发人员写接口文档，并经过评审

### 测试团队的改变

- 通用技能
  - 初步的编程基础
  - 掌握一门功能较强的脚本语言
- 针对 B/S 软件的技能
  - HTML
  - HTTP 协议的常识，知道常见的 HTTP 状态码
  - JavaScript
- 针对 C/S 软件的技能
  - C 语言
  - 标准输入/标准输出/管道
- 数据库相关的技能
  - 基本 SQL 语法
  - 使用脚本进行数据库记录的增删改查
- 网络相关的技能
  - 基本的网络知识：TCP/UDP 的概念
  - 使用脚本进行简单的 SOCKET 编程

## 模块接口类型概述

### 接口分类

- 是否跨进程
  - 进程内
  - 跨进程
- 是否跨主机
  - 主机内
  - 跨主机

从耦合角度看，跨主机交互比主机内交互耦合低；跨进程交互比进程内交互耦合低。

由于不存在“跨主机不跨进程”的接口方式，所以上述分类有 3 种可能：

- 跨主机
- 主机内跨进程
- 进程内

### 测试跨主机的模块接口

在 TCP/IP 协议栈中，模块间的交互方式主要位于传输层和应用层。

有一些软件系统实现了专有的应用层协议。这种情况下，测试人员需要大致了解传输层的知识以及该专有应用协议的格式。

#### 基于 Web 接口的交互（HTTP 协议）

针对服务端进行灰盒测试，需要模拟客户端的各种 HTTP 请求。既包括合法的请求，也要包括各种非法的、无效的请求。

如果响应内容不符合接口文档的约定，就表明该服务端模块出 Bug 了。

- 使用内置的标准模块
- cURL

#### 基于数据库的交互

测试人员需要用测试脚本，在数据库中制造测试数据，作为软件模块的输入；
或者在软件模块把数据保存到数据库，验证其输出的数据是否符合接口约定。

- 跨数据库的接口：指编程接口支持多种数据库产品
  - ODBC：跨数据库、跨操作系统、跨编程语言的数据库接口。大部分知名数据库软件都支持 ODBC
    方式访问。
  - JDBC
  - ADO/ADO.Net
- 特定数据库的接口：几种常见数据库及其对应的 Python 开源项目
  - Oracle: cx_Oracle
  - SQL Server: pymssql
  - DB2: pydb2
  - MySQL: MySQL-Python
  - PostgreSQL: psycopg2
  - SQLite: Python 内置
- Python 社区制定了一个数据库操作的规范：[PEP 249 – Python Database API Specification v2.0](https://peps.python.org/pep-0249/)

#### 基于网络文件系统的交互（NFS）

可以等同于主机内的跨进程交互方式。

#### 基于其它应用层协议的交互

PycURL 支持十几种应用层协议

- FTP/FTPS
- Gopher
- SCP
- SFTP/TFTP
- TELNET
- LDAP/LDAPS
- IMAP/POP3/SMTP

#### 基于 Socket 的交互

Python 的 socket API 和传统的伯克利套接字 API 类似。

用脚本模拟软件模块之间的 socket 通讯，主要难点往往不在于 socket，而在于专有协议本身。
