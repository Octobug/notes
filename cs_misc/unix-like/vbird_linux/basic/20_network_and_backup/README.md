# 第二十章 网络设置与备份策略

> <https://linux.vbird.org/linux_basic/centos7/0610hardware.php>

- [第二十章 网络设置与备份策略](#第二十章-网络设置与备份策略)
  - [20.1 系统基本设置](#201-系统基本设置)
    - [20.1.1 网络设置（手动设置与 DHCP）](#2011-网络设置手动设置与-dhcp)
    - [20.1.2 日期与时间设置](#2012-日期与时间设置)
    - [20.1.3 语系设置](#2013-语系设置)
    - [20.1.4 防火墙简易设置](#2014-防火墙简易设置)
  - [20.2 服务器硬件数据的收集](#202-服务器硬件数据的收集)
    - [20.2.1 以系统内置 dmidecode 解析硬件设备](#2021-以系统内置-dmidecode-解析硬件设备)
    - [20.2.2 硬件资源的收集与分析](#2022-硬件资源的收集与分析)
    - [20.2.3 了解磁盘的健康状态](#2023-了解磁盘的健康状态)
  - [20.3 备份要点](#203-备份要点)
    - [20.3.1 备份数据的考虑](#2031-备份数据的考虑)
    - [20.3.2 哪些 Linux 数据具有备份的意义](#2032-哪些-linux-数据具有备份的意义)
    - [20.3.3 备份用存储媒介的选择](#2033-备份用存储媒介的选择)
  - [20.4 备份的种类、频率与工具的选择](#204-备份的种类频率与工具的选择)
    - [20.4.1 完整备份之累积备份 (Incremental backup)](#2041-完整备份之累积备份-incremental-backup)
    - [20.4.2 完整备份之差异备份 (Differential backup)](#2042-完整备份之差异备份-differential-backup)
    - [20.4.3 关键数据备份](#2043-关键数据备份)
  - [20.5 鸟哥的备份策略](#205-鸟哥的备份策略)
    - [20.5.1 每周系统备份的 script](#2051-每周系统备份的-script)
    - [20.5.2 每日数据备份的 script](#2052-每日数据备份的-script)
    - [20.5.3 远程备份的 script](#2053-远程备份的-script)
  - [20.6 备份还原的考虑](#206-备份还原的考虑)
  - [20.7 重点回顾](#207-重点回顾)
  - [20.8 本章习题](#208-本章习题)
  - [20.9 参考资料与延伸阅读](#209-参考资料与延伸阅读)

## 20.1 系统基本设置

### 20.1.1 网络设置（手动设置与 DHCP）

- 手动设置固定 IP
  - 重要参数
    - IP
    - netmask (子网掩码)
    - gateway (网关)
    - DNS 主机 IP
  - 常见网卡名称: `ifconfig -a`
    - eno1: 主板内置网卡
    - ens1: 主板内置的 PCI-E 接口网卡
    - enp2s0: PCI-E 接口的独立网卡，可能有多个接口，s0, s1 ...
    - eth0: 默认网卡
  - 设置命令：`nmcli`
- DHCP
- 修改主机名称：hostnamectl

### 20.1.2 日期与时间设置

- `timedatectl [SUBCMD]`:时区的显示与设置
  - `list-timezones`: 列出所有支持的时区
  - `set-timezone`: 设置时区
  - `set-time`: 设置时间，格式为 "yyyy-mm-dd HH:MM"
  - `set-ntp`: 设置网络校时系统
- `ntpdate`: 手动网络校时
- `hwclock`: 校正 BIOS 时间

### 20.1.3 语系设置

- localectl

### 20.1.4 防火墙简易设置

- iptables
- CentOS: `firewalld`/`firewall-cmd`
- Ubuntu: `ufw`

## 20.2 服务器硬件数据的收集

### 20.2.1 以系统内置 dmidecode 解析硬件设备

`dmidecode -t TYPE`

- TYPE
  - 1: 详细的系统数据，包括主板型号等硬件基础信息
  - 4: CPU 详细信息
  - 9: 主板插槽规格
  - 17: 每一个内存插槽规格，如果有内存会列出内存规格

### 20.2.2 硬件资源的收集与分析

- gdisk: 磁盘管理工具
- dmesg: 获取内核运行过程的信息
- vmstat: 分析系统 (CPU/RAM/IO) 当前状态
- 基于 `/usr/share/hwdata/pci/ids` 的硬件信息，可使用 `update-pciids` 更新
  - lspci: 列出所有 PCI 接口设备
  - lsusb: 列出所有 USB 接口设备
- iostat: 与 vmstat 类似，可实时列出 CPU 与周边设备的 I/O 状态

### 20.2.3 了解磁盘的健康状态

`smartd`: SMART, Self-Monitoring, Analysis and Reporting Technology System

- smartctl

## 20.3 备份要点

### 20.3.1 备份数据的考虑

- 硬件问题
- 软件与人的问题
- 主机角色不同，备份任务也不同
- 备份因素考虑
  - 备份哪些文件
    - `/etc`
    - `/home`
  - 选择什么备份媒介
  - 备份方式
    - 完整备份
    - 差异备份
  - 备份频率
  - 备份工具
    - tar
    - cpio
    - dd
    - dump

### 20.3.2 哪些 Linux 数据具有备份的意义

- 文件
  - `/boot`
  - `/etc`
  - `/home`
  - `/root`
  - `/var/lib`
  - `/var/spool/at`
  - `/var/spool/cron`
  - `/var/spool/mail`
- 网络服务的数据
  - 数据库
  - 文件

### 20.3.3 备份用存储媒介的选择

- 异地备份系统
- 存储媒介的考虑
  - NAS
  - 磁盘
  - 磁带

## 20.4 备份的种类、频率与工具的选择

### 20.4.1 完整备份之累积备份 (Incremental backup)

- 还原的考虑: 完整备份的还原更方便
- 累积备份的原则
  - 除了第一次备份，后续的每次备份只有差异文件
  - 还原需要按顺序

### 20.4.2 完整备份之差异备份 (Differential backup)

每次备份都是与原始完整备份比较的结果，而不依赖上一次差异备份。

### 20.4.3 关键数据备份

`tar -jpcvf mysql.$(date +%Y-%m-%d）.tar.bz2 /var/lib/mysql`

## 20.5 鸟哥的备份策略

1. 挂载独立文件系统到 `/backup`
2. 每日备份：数据库
3. 每周备份：系统文件目录
4. 自动处理：`/etc/crontab`
5. 每月备份：异地备份
    - 数据烧录到光盘
    - 网络传输到异地

### 20.5.1 每周系统备份的 script

[backup_weekly.sh](backup_weekly.sh)

### 20.5.2 每日数据备份的 script

[backup_daily.sh](backup_daily.sh)

### 20.5.3 远程备份的 script

- 使用 rsync 同步备份数据: [backup_rsync.sh](backup_rsync.sh)

## 20.6 备份还原的考虑

- 硬件损坏，且有完整备份的数据时: 修复硬件后直接完整复原
- 由于软件问题产生的被攻击事件
  1. 断开网络
  2. 审查登录日志，排查可疑点
  3. 重新安装系统
  4. 升级系统、配置防火墙
  5. 按照 2. 的排查结果，修复漏洞
  6. 恢复数据
  7. 重新上线并测试

## 20.7 重点回顾

## 20.8 本章习题

## 20.9 参考资料与延伸阅读
