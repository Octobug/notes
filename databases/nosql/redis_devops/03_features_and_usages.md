# ç¬¬3ç«  å°åŠŸèƒ½å¤§ç”¨å¤„

- [ç¬¬3ç«  å°åŠŸèƒ½å¤§ç”¨å¤„](#ç¬¬3ç« -å°åŠŸèƒ½å¤§ç”¨å¤„)
  - [3.1 æ…¢æŸ¥è¯¢åˆ†æ](#31-æ…¢æŸ¥è¯¢åˆ†æ)
    - [3.1.1 æ…¢æŸ¥è¯¢çš„ä¸¤ä¸ªé…ç½®å‚æ•°](#311-æ…¢æŸ¥è¯¢çš„ä¸¤ä¸ªé…ç½®å‚æ•°)
      - [1. è·å–æ…¢æŸ¥è¯¢æ—¥å¿—](#1-è·å–æ…¢æŸ¥è¯¢æ—¥å¿—)
      - [2. è·å–æ…¢æŸ¥è¯¢æ—¥å¿—åˆ—è¡¨é•¿åº¦](#2-è·å–æ…¢æŸ¥è¯¢æ—¥å¿—åˆ—è¡¨é•¿åº¦)
      - [3. æ…¢æŸ¥è¯¢æ—¥å¿—é‡ç½®](#3-æ…¢æŸ¥è¯¢æ—¥å¿—é‡ç½®)
    - [3.1.2 æœ€ä½³å®è·µ](#312-æœ€ä½³å®è·µ)
  - [3.2 Redis Shell](#32-redis-shell)
    - [3.2.1 redis-cli è¯¦è§£](#321-redis-cli-è¯¦è§£)
      - [1. -r: repeat](#1--r-repeat)
      - [2. -i: interval](#2--i-interval)
      - [3. -x: è¯»å– stdin](#3--x-è¯»å–-stdin)
      - [4. -c: cluster](#4--c-cluster)
      - [5. -a: auth](#5--a-auth)
      - [6. --scan å’Œ --pattern](#6---scan-å’Œ---pattern)
      - [7. --slave](#7---slave)
      - [8. --rdb](#8---rdb)
      - [9. --pipe](#9---pipe)
      - [10. --bigkeys](#10---bigkeys)
      - [11. --eval](#11---eval)
      - [12. --latency](#12---latency)
      - [13. --stat](#13---stat)
      - [14. --raw å’Œ --no-raw](#14---raw-å’Œ---no-raw)
    - [3.2.2 redis-server è¯¦è§£](#322-redis-server-è¯¦è§£)
    - [3.2.3 redis-benchmark è¯¦è§£](#323-redis-benchmark-è¯¦è§£)
      - [1. -c: clients](#1--c-clients)
      - [2. -n \[requests\]](#2--n-requests)
      - [3. -q: requests per second](#3--q-requests-per-second)
      - [4. -r: random](#4--r-random)
      - [5. -P: æ¯ä¸ªè¯·æ±‚ pipeline çš„å‘½ä»¤æ•°é‡](#5--p-æ¯ä¸ªè¯·æ±‚-pipeline-çš„å‘½ä»¤æ•°é‡)
      - [6. -k: keepalive \[boolean\]](#6--k-keepalive-boolean)
      - [7. -t: test](#7--t-test)
      - [8. --csv](#8---csv)
  - [3.3 Pipeline](#33-pipeline)
    - [3.3.1 Pipeline æ¦‚å¿µ](#331-pipeline-æ¦‚å¿µ)
    - [3.3.2 æ€§èƒ½æµ‹è¯•](#332-æ€§èƒ½æµ‹è¯•)
    - [3.3.3 åŸç”Ÿæ‰¹é‡å‘½ä»¤ä¸ Pipeline å¯¹æ¯”](#333-åŸç”Ÿæ‰¹é‡å‘½ä»¤ä¸-pipeline-å¯¹æ¯”)
    - [3.3.4 æœ€ä½³å®è·µ](#334-æœ€ä½³å®è·µ)
  - [3.4 äº‹åŠ¡ä¸ Lua](#34-äº‹åŠ¡ä¸-lua)
    - [3.4.1 äº‹åŠ¡](#341-äº‹åŠ¡)
      - [1.å‘½ä»¤é”™è¯¯](#1å‘½ä»¤é”™è¯¯)
      - [2.è¿è¡Œæ—¶é”™è¯¯](#2è¿è¡Œæ—¶é”™è¯¯)
    - [3.4.2 Luaç”¨æ³•ç®€è¿°](#342-luaç”¨æ³•ç®€è¿°)
      - [1.æ•°æ®ç±»å‹åŠå…¶é€»è¾‘å¤„ç†](#1æ•°æ®ç±»å‹åŠå…¶é€»è¾‘å¤„ç†)
        - [1.1 å­—ç¬¦ä¸²](#11-å­—ç¬¦ä¸²)
        - [1.2 æ•°ç»„](#12-æ•°ç»„)
        - [1.3 for](#13-for)
        - [1.4 while](#14-while)
        - [1.5 if else](#15-if-else)
        - [1.6 å“ˆå¸Œ](#16-å“ˆå¸Œ)
      - [2.å‡½æ•°å®šä¹‰](#2å‡½æ•°å®šä¹‰)
    - [3.4.3 Redis ä¸ Lua](#343-redis-ä¸-lua)
      - [1.åœ¨ Redis ä¸­ä½¿ç”¨ Lua](#1åœ¨-redis-ä¸­ä½¿ç”¨-lua)
        - [1.1 eval](#11-eval)
        - [1.2 evalsha](#12-evalsha)
      - [2.Lua çš„ Redis API](#2lua-çš„-redis-api)
    - [3.4.4 æ¡ˆä¾‹](#344-æ¡ˆä¾‹)
    - [3.4.5 Redis å¦‚ä½•ç®¡ç† Lua è„šæœ¬](#345-redis-å¦‚ä½•ç®¡ç†-lua-è„šæœ¬)
  - [3.5 Bitmaps](#35-bitmaps)
    - [3.5.1 æ•°æ®ç»“æ„æ¨¡å‹](#351-æ•°æ®ç»“æ„æ¨¡å‹)
    - [3.5.2 å‘½ä»¤](#352-å‘½ä»¤)
      - [1.è®¾ç½®å€¼](#1è®¾ç½®å€¼)
      - [2.è·å–å€¼](#2è·å–å€¼)
      - [3.è·å– Bitmaps æŒ‡å®šèŒƒå›´å€¼ä¸º 1 çš„ä¸ªæ•°](#3è·å–-bitmaps-æŒ‡å®šèŒƒå›´å€¼ä¸º-1-çš„ä¸ªæ•°)
      - [4.Bitmaps é—´çš„è¿ç®—](#4bitmaps-é—´çš„è¿ç®—)
      - [5.è®¡ç®— Bitmaps ä¸­ç¬¬ä¸€ä¸ªå€¼ä¸º targetBit çš„åç§»é‡](#5è®¡ç®—-bitmaps-ä¸­ç¬¬ä¸€ä¸ªå€¼ä¸º-targetbit-çš„åç§»é‡)
    - [3.5.3 Bitmaps åˆ†æ](#353-bitmaps-åˆ†æ)
  - [3.6 HyperLogLog](#36-hyperloglog)
    - [1.æ·»åŠ ](#1æ·»åŠ )
    - [2.è®¡ç®—ç‹¬ç«‹ç”¨æˆ·æ•°](#2è®¡ç®—ç‹¬ç«‹ç”¨æˆ·æ•°)
    - [3.åˆå¹¶](#3åˆå¹¶)
  - [3.7 å‘å¸ƒè®¢é˜…](#37-å‘å¸ƒè®¢é˜…)
    - [3.7.1 å‘½ä»¤](#371-å‘½ä»¤)
      - [1.å‘å¸ƒæ¶ˆæ¯](#1å‘å¸ƒæ¶ˆæ¯)
      - [2.è®¢é˜…æ¶ˆæ¯](#2è®¢é˜…æ¶ˆæ¯)
      - [3.å–æ¶ˆè®¢é˜…](#3å–æ¶ˆè®¢é˜…)
      - [4.æŒ‰ç…§æ¨¡å¼è®¢é˜…å’Œå–æ¶ˆè®¢é˜…](#4æŒ‰ç…§æ¨¡å¼è®¢é˜…å’Œå–æ¶ˆè®¢é˜…)
      - [5.æŸ¥è¯¢è®¢é˜…](#5æŸ¥è¯¢è®¢é˜…)
        - [5.1 æŸ¥çœ‹æ´»è·ƒçš„é¢‘é“](#51-æŸ¥çœ‹æ´»è·ƒçš„é¢‘é“)
        - [5.2 æŸ¥çœ‹é¢‘é“è®¢é˜…æ•°](#52-æŸ¥çœ‹é¢‘é“è®¢é˜…æ•°)
        - [5.3 æŸ¥çœ‹æ¨¡å¼è®¢é˜…æ•°](#53-æŸ¥çœ‹æ¨¡å¼è®¢é˜…æ•°)
    - [3.7.2 ä½¿ç”¨åœºæ™¯](#372-ä½¿ç”¨åœºæ™¯)
  - [3.8 GEO](#38-geo)
    - [1.å¢åŠ åœ°ç†ä½ç½®ä¿¡æ¯](#1å¢åŠ åœ°ç†ä½ç½®ä¿¡æ¯)
    - [2.è·å–åœ°ç†ä½ç½®ä¿¡æ¯](#2è·å–åœ°ç†ä½ç½®ä¿¡æ¯)
    - [3.è·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦»](#3è·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦»)
    - [4.è·å–æŒ‡å®šä½ç½®èŒƒå›´å†…çš„åœ°ç†ä¿¡æ¯ä½ç½®é›†åˆ](#4è·å–æŒ‡å®šä½ç½®èŒƒå›´å†…çš„åœ°ç†ä¿¡æ¯ä½ç½®é›†åˆ)
    - [5.è·å– geohash](#5è·å–-geohash)
    - [6.åˆ é™¤åœ°ç†ä½ç½®ä¿¡æ¯](#6åˆ é™¤åœ°ç†ä½ç½®ä¿¡æ¯)
  - [3.9 æœ¬ç« é‡ç‚¹å›é¡¾](#39-æœ¬ç« é‡ç‚¹å›é¡¾)

é™¤äº† Redis æä¾›çš„ 5 ç§æ•°æ®ç»“æ„ä¹‹å¤–ï¼ŒRedis è¿˜æä¾›äº†è¯¸å¦‚

- æ…¢æŸ¥è¯¢åˆ†æï¼šé€šè¿‡æ…¢æŸ¥è¯¢åˆ†æï¼Œæ‰¾åˆ°æœ‰é—®é¢˜çš„å‘½ä»¤è¿›è¡Œä¼˜åŒ–ã€‚
- Redis Shellï¼šåŠŸèƒ½å¼ºå¤§çš„ Redis Shell ä¼šæœ‰æ„æƒ³ä¸åˆ°çš„å®ç”¨åŠŸèƒ½ã€‚
- Pipelineï¼šé€šè¿‡ Pipeline æœºåˆ¶æœ‰æ•ˆæé«˜å®¢æˆ·ç«¯æ€§èƒ½ã€‚
- äº‹åŠ¡ä¸ Lua è„šæœ¬ï¼šåˆ¶ä½œè‡ªå·±çš„ä¸“å±åŸå­å‘½ä»¤ã€‚
- Bitmapsï¼šé€šè¿‡åœ¨å­—ç¬¦ä¸²æ•°æ®ç»“æ„ä¸Šä½¿ç”¨ä½æ“ä½œï¼Œæœ‰æ•ˆèŠ‚çœå†…å­˜ï¼Œä¸ºå¼€å‘æä¾›æ–°çš„æ€è·¯ã€‚
- HyperLogLogï¼šä¸€ç§åŸºäºæ¦‚ç‡çš„æ–°ç®—æ³•ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´ã€‚
- å‘å¸ƒè®¢é˜…ï¼šåŸºäºå‘å¸ƒè®¢é˜…æ¨¡å¼çš„æ¶ˆæ¯é€šä¿¡æœºåˆ¶ã€‚
- GEOï¼šæä¾›äº†åŸºäºåœ°ç†ä½ç½®ä¿¡æ¯çš„åŠŸèƒ½ã€‚

ç­‰é™„åŠ åŠŸèƒ½ã€‚

## 3.1 æ…¢æŸ¥è¯¢åˆ†æ

Redis æ‰§è¡Œå®¢æˆ·ç«¯å‘½ä»¤çš„ç”Ÿå‘½å‘¨æœŸï¼š

1. å‘é€å‘½ä»¤
2. å‘½ä»¤æ’é˜Ÿ
3. å‘½ä»¤æ‰§è¡Œï¼ˆæ…¢æŸ¥è¯¢åªç»Ÿè®¡è¿™ä¸€æ­¥ï¼‰
4. è¿”å›ç»“æœ

### 3.1.1 æ…¢æŸ¥è¯¢çš„ä¸¤ä¸ªé…ç½®å‚æ•°

ä¸¤ä¸ªé—®é¢˜éœ€è¦æ˜ç¡®ï¼š

1. é¢„è®¾é˜ˆå€¼æ€ä¹ˆè®¾ç½®ï¼Ÿ
    - `slowlog-log-slower-than`: us, é»˜è®¤å€¼ 10000 (10ms)
    - `= 0` æ—¶ä¼šè®°å½•æ‰€æœ‰å‘½ä»¤
    - `< 0` æ—¶ä¸ä¼šè®°å½•ä»»ä½•å‘½ä»¤
2. æ…¢æŸ¥è¯¢è®°å½•å­˜æ”¾åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Ÿ
    - `slowlog-max-len`: å­˜å‚¨æ…¢æŸ¥è¯¢æ—¥å¿—çš„åˆ—è¡¨æœ€å¤§é•¿åº¦

å¦‚ä½•ä¿®æ”¹ï¼Ÿ

```redis
config set slowlog-log-slower-than 20000
config set slowlog-max-len 1000

# æŒä¹…åŒ–åˆ°æœ¬åœ°é…ç½®æ–‡ä»¶
config rewrite
```

#### 1. è·å–æ…¢æŸ¥è¯¢æ—¥å¿—

```redis
slowlog get [n]
```

æ¯ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—æœ‰ 4 ä¸ªå±æ€§ï¼š

- id
- time: æ—¶é—´æˆ³
- duration: è€—æ—¶
- command + args: å…·ä½“å‘½ä»¤å’Œå‚æ•°

#### 2. è·å–æ…¢æŸ¥è¯¢æ—¥å¿—åˆ—è¡¨é•¿åº¦

```redis
slowlog len
```

#### 3. æ…¢æŸ¥è¯¢æ—¥å¿—é‡ç½®

```redis
slowlog reset
```

### 3.1.2 æœ€ä½³å®è·µ

- `slowlog-max-len`: ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½® 1000 ä»¥ä¸Š
  - è®°å½•æ…¢æŸ¥è¯¢æ—¶ Redis ä¼šå¯¹é•¿å‘½ä»¤åšæˆªæ–­æ“ä½œï¼Œå› æ­¤ä¸ä¼šå ç”¨å¤§é‡å†…å­˜
  - å¢å¤§åˆ—è¡¨ä¸Šé™å¯ä»¥å‡ç¼“æ…¢æŸ¥è¯¢è¢«å‰”é™¤çš„å¯èƒ½
- `slowlog-log-slower-than`: é»˜è®¤å€¼ä¸º 10msï¼Œéœ€è¦æ ¹æ®å®é™…å¹¶å‘é‡è°ƒæ•´
  - å¯¹äºé«˜æµé‡åœºæ™¯ï¼Œå»ºè®®è®¾ç½®ä¸º 1ms (OPS 1000)
- æ…¢æŸ¥è¯¢è®°å½•çš„æ—¶é—´ä¸åŒ…æ‹¬å‘½ä»¤æ’é˜Ÿå’Œç½‘ç»œä¼ è¾“æ—¶é—´ï¼Œå› æ­¤å®¢æˆ·ç«¯å®é™…æ‰§è¡Œæ—¶é—´ä¼šå¤§äºå‘½ä»¤æ‰§è¡Œæ—¶é—´ã€‚
  - å¦‚æœå®¢æˆ·ç«¯å‡ºç°è¯·æ±‚è¶…æ—¶ï¼Œéœ€è¦æ£€æŸ¥è¯¥æ—¶é—´ç‚¹æ˜¯å¦æœ‰å¯¹åº”çš„æ…¢æŸ¥è¯¢
- å®šæœŸæ‰§è¡Œ `slowlog get` å°†æ…¢æŸ¥è¯¢å¯¼å‡ºæŒä¹…åŒ–åˆ°å…¶ä»–å­˜å‚¨ä¸­
  - Redis ç§æœ‰äº‘ CacheCloud æä¾›äº†è¿™æ ·çš„åŠŸèƒ½

## 3.2 Redis Shell

### 3.2.1 redis-cli è¯¦è§£

é‡è¦å‚æ•°åŠå…¶ä½¿ç”¨åœºæ™¯ï¼š

#### 1. -r: repeat

```sh
redis-cli -r 3 ping
```

#### 2. -i: interval

```sh
# æ¯éš” 1s æ‰§è¡Œä¸€æ¬¡ pingï¼Œå…± 5 æ¬¡
redis-cli -r 5 -i 1 ping

# æ”¯æŒå°æ•°
redis-cli -r 5 -i 0.01 ping
```

#### 3. -x: è¯»å– stdin

ä½œä¸º redis-cli æœ€åä¸€ä¸ªå‚æ•°

```sh
echo "world" | redis-cli -x set hello
```

#### 4. -c: cluster

è¿æ¥ Redis Cluster èŠ‚ç‚¹æ—¶ä½¿ç”¨ï¼Œé˜²æ­¢ moved å’Œ ask å¼‚å¸¸

#### 5. -a: auth

ç”¨äºè¾“å…¥å¯†ç 

#### 6. --scan å’Œ --pattern

ç”¨äºæ‰«ææŒ‡å®šæ¨¡å¼çš„é”®ï¼Œç›¸å½“äºä½¿ç”¨ scan å‘½ä»¤

#### 7. --slave

æŠŠå½“å‰å®¢æˆ·ç«¯æ¨¡æ‹Ÿæˆå½“å‰ Redis èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼Œç”¨æ¥è·å–å½“å‰èŠ‚ç‚¹çš„æ›´æ–°æ“ä½œã€‚è¿™äº›æ“ä½œå¯èƒ½æ—¶å®é™…å¼€å‘ä¸šåŠ¡æ—¶éœ€è¦çš„æ•°æ®ã€‚

```sh
redis-cli --slave
# SYNC with master, discarding 72 bytes of bulk transfer...
# SYNC done. Logging commands from master.
# "PING"
# "PING"
# "PING"
# "PING"
# "PING"
# "SELECT","0"
# "set","hello","world"
# "set","a","b"
# "PING"
# "incr","count"
```

#### 8. --rdb

ä½¿ Redis ç”Ÿæˆ RDB æŒä¹…åŒ–æ–‡ä»¶ï¼Œä¿å­˜åœ¨æœ¬åœ°ã€‚

#### 9. --pipe

ç”¨äºå°†å‘½ä»¤å°è£…æˆ Redis é€šä¿¡åè®®å®šä¹‰çš„æ•°æ®æ ¼å¼ï¼Œæ‰¹é‡å‘é€ç»™ Redis æ‰§è¡Œã€‚

```sh
echo -en '*3\r\n$3\r\n....' | redis-cli --pipe
```

#### 10. --bigkeys

è¿™ä¸ªé€‰é¡¹ä½¿ç”¨ scan å‘½ä»¤å¯¹ Redis è¿›è¡Œé”®é‡‡æ ·ï¼Œæ‰¾å‡ºå†…å­˜å æ¯”è¾ƒå¤§çš„é”®å€¼ï¼Œè¿™äº›é”®å¯èƒ½æ˜¯ç³»ç»Ÿç“¶é¢ˆã€‚

#### 11. --eval

æ‰§è¡ŒæŒ‡å®š Lua è„šæœ¬

#### 12. --latency

æœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š

1. --latency: æµ‹è¯•å®¢æˆ·ç«¯åˆ° Redis çš„ç½‘ç»œå»¶è¿Ÿï¼Œåªæœ‰èšåˆç»“æœ
2. --latency-history: åˆ†æ—¶æ®µç»Ÿè®¡ç»“æœ
3. --latency-dist: è¾“å‡ºç»Ÿè®¡å›¾è¡¨

#### 13. --stat

å®æ—¶è·å– Redis é‡è¦ç»Ÿè®¡ä¿¡æ¯ï¼Œinfo çš„ä¿¡æ¯æ›´å…¨ï¼Œä½†å®ƒä¸å®æ—¶ã€‚

#### 14. --raw å’Œ --no-raw

```sh
redis-cli --raw get hello
# ä½ å¥½

redis-cli --no-raw get hello 
# "\xe4\xbd\xa0\xe5\xa5\xbd"
```

### 3.2.2 redis-server è¯¦è§£

`--test-memory`: ç”¨æ¥æ£€æµ‹å½“å‰æ“ä½œç³»ç»Ÿèƒ½å¦ç¨³å®šåˆ†é… Redis æŒ‡å®šå®¹é‡çš„å†…å­˜ï¼Œé¿å…å› ä¸ºå†…å­˜é—®é¢˜é€ æˆå´©æºƒã€‚

```sh
# å•ä½ä¸º 1MB
redis-server --test-memory 1024
```

é€šå¸¸æ— éœ€æ¯æ¬¡éƒ½æµ‹è¯•ï¼Œä¸€èˆ¬ç”¨äºç‰¹å®šåœºæ™¯è°ƒè¯•å’Œæµ‹è¯•ã€‚

### 3.2.3 redis-benchmark è¯¦è§£

#### 1. -c: clients

å®¢æˆ·ç«¯å¹¶å‘é‡ï¼Œé»˜è®¤ 50

#### 2. -n [requests]

æ€»è¯·æ±‚é‡ï¼Œé»˜è®¤ 100,000ã€‚Redis ä¼šä½¿ç”¨å„ç±»æ•°æ®ç»“æœè¿›è¡Œæµ‹è¯•

```sh
# 100 å®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚ Redis, ä¸€å…± 20000 æ¬¡
redis-benchmark -c 100 -n 20000
```

#### 3. -q: requests per second

ä»…ä»…æ˜¾ç¤º requests per second ä¿¡æ¯

#### 4. -r: random

æµ‹è¯•æ—¶æ’å…¥éšæœºçš„é”®ï¼Œå®ƒä¼šåœ¨ `key`, `counter` é”®åŠ ä¸Š 12 ä½çš„åç¼€ï¼Œ`-r 10000` ä»£è¡¨åªå¯¹å4ä½åšéšæœºå¤„ç†ï¼ˆè€Œä¸æ˜¯éšæœºçš„ä¸ªæ•°ï¼‰ã€‚

```sh
redis-benchmark -c 100 -n 20000 -r 10000
```

#### 5. -P: æ¯ä¸ªè¯·æ±‚ pipeline çš„å‘½ä»¤æ•°é‡

é»˜è®¤ä¸º 1

#### 6. -k: keepalive [boolean]

- `0`: ä¸ä½¿ç”¨
- `1`: ä½¿ç”¨ï¼Œé»˜è®¤å€¼

#### 7. -t: test

å¯¹æŒ‡å®šå‘½ä»¤è¿›è¡ŒåŸºå‡†æµ‹è¯•

```sh
redis-benchmark -t get, set -q
```

#### 8. --csv

ç»“æœæŒ‰ç…§ csv æ ¼å¼è¾“å‡ºã€‚

## 3.3 Pipeline

### 3.3.1 Pipeline æ¦‚å¿µ

Redis å®¢æˆ·ç«¯æ‰§è¡Œä¸€æ¡å‘½ä»¤æœ‰ 4 ä¸ªæ­¥éª¤ï¼š

1. å‘é€å‘½ä»¤
2. å‘½ä»¤æ’é˜Ÿ
3. å‘½ä»¤æ‰§è¡Œ
4. è¿”å›ç»“æœ

`1.` + `4.` çš„è€—æ—¶ç§°ä¸º RTT: Round Trip Timeã€‚

æ‰¹é‡æ“ä½œå‘½ä»¤å¦‚ `mget`ã€`mset` å¯ä»¥æœ‰æ•ˆåœ°èŠ‚çº¦ RTTï¼Œä½†æ˜¯è¿˜æœ‰å¾ˆå¤šå…¶ä»–å‘½ä»¤ä¸æ”¯æŒæ‰¹é‡æ“ä½œã€‚å¯¹äºåœ°ç†è·ç¦»é¥è¿œçš„å®¢æˆ·ç«¯ä¸èŠ‚ç‚¹ï¼ŒRTT ä¼šæµªè´¹å¤§é‡æ—¶é—´ã€‚

Pipeline æœºåˆ¶èƒ½æ”¹å–„ä¸Šé¢è¿™ç±»é—®é¢˜ï¼Œå®ƒèƒ½å°†ä¸€ç»„å‘½ä»¤ç»„è£…åé€šè¿‡ä¸€æ¬¡ RTT ä¼ è¾“ç»™ Redisï¼Œå†å°†ç»“æœæŒ‰é¡ºåºè¿”å›ã€‚

Pipeline N æ¡å‘½ä»¤å¯ä»¥èŠ‚çº¦ N - 1 æ¬¡ RTTã€‚

`--pipe` å®é™…ä¸Šä¹Ÿæ˜¯åˆ©ç”¨äº† pipeline æœºåˆ¶ã€‚ä¸è¿‡å¤§éƒ¨åˆ†æ—¶å€™æ˜¯åœ¨åº”ç”¨ä»£ç ä¸­ä½¿ç”¨è¿™ä¸ªé€‰é¡¹ã€‚

```sh
echo -en '*3...SET\r\n...INCR\r\n....' | redis-cli --pipe
```

### 3.3.2 æ€§èƒ½æµ‹è¯•

- Pipeline æ‰§è¡Œé€Ÿåº¦ä¸€èˆ¬æ¯”é€æ¡æ‰§è¡Œå¿«
- RTT è¶Šå¤§ï¼ŒPipeline æ•ˆæœè¶Šæ˜æ˜¾

### 3.3.3 åŸç”Ÿæ‰¹é‡å‘½ä»¤ä¸ Pipeline å¯¹æ¯”

- åŸç”Ÿæ‰¹é‡å‘½ä»¤æ˜¯åŸå­çš„ï¼ŒPipeline æ˜¯éåŸå­çš„
- åŸç”Ÿæ‰¹é‡å‘½ä»¤æ˜¯ä¸€ä¸ªå‘½ä»¤å¯¹åº”å¤šä¸ª keyï¼ŒPipeline æ”¯æŒå¤šä¸ªå‘½ä»¤
- åŸç”Ÿæ‰¹é‡å‘½ä»¤æ˜¯æœåŠ¡ç«¯æ”¯æŒå®ç°çš„ï¼Œè€Œ Pipeline éœ€è¦æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å…±åŒæ”¯æŒ

### 3.3.4 æœ€ä½³å®è·µ

- è¿‡å¤§çš„ Pipeline å‘½ä»¤æ•°é‡ä¼šå¢åŠ å®¢æˆ·ç«¯çš„ç­‰å¾…æ—¶é—´ä»¥åŠç½‘ç»œæ‹¥å µ
- Pipeline åªèƒ½æ“ä½œä¸€ä¸ª Redis å®ä¾‹ï¼›ä¸è¿‡åœ¨åˆ†å¸ƒå¼åœºæ™¯ä¸­ä»ç„¶æ˜¯é‡è¦çš„ä¼˜åŒ–æ‰‹æ®µ

## 3.4 äº‹åŠ¡ä¸ Lua

ä¸ºäº†ä¿è¯å¤šæ¡å‘½ä»¤ç»„åˆçš„åŸå­æ€§ï¼ŒRedis æä¾›äº†ï¼š

- ç®€å•çš„äº‹åŠ¡
- é›†æˆ Lua è„šæœ¬å®šåˆ¶åŸå­å‘½ä»¤

### 3.4.1 äº‹åŠ¡

å°†ä¸€ç»„éœ€è¦ä¸€èµ·æ‰§è¡Œçš„å‘½ä»¤æ”¾åˆ° `multi` å’Œ `exec` ä¸¤ä¸ªå‘½ä»¤ä¹‹é—´ï¼Œ`multi` ä»£è¡¨äº‹åŠ¡å¼€å§‹ï¼Œ`exec`
ä»£è¡¨äº‹åŠ¡ç»“æŸï¼Œå®ƒä»¬ä¹‹é—´çš„å‘½ä»¤æ˜¯åŸå­é¡ºåºæ‰§è¡Œçš„ã€‚

```redis
multi
# OK
sadd user:a:follow user:b
# QUEUED
sadd user:b:fans user:a
# QUEUED
exec
```

QUEUED è¡¨æ˜å‘½ä»¤æ²¡æœ‰çœŸæ­£æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶å¦ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œ `sismember user:a:follow user:b`
ä¼šè¿”å› 0ã€‚æ‰§è¡Œ `exec` åäº‹åŠ¡æ‰å®Œæˆã€‚

`discard` å¯ä»¥ä¸­æ­¢äº‹åŠ¡ã€‚

#### 1.å‘½ä»¤é”™è¯¯

å¦‚æœäº‹åŠ¡ä¸­æŸä¸ªå‘½ä»¤æ‹¼å†™é”™è¯¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡æ’¤é”€ã€‚

#### 2.è¿è¡Œæ—¶é”™è¯¯

ä¾‹å¦‚ï¼Œç”¨é”™å‘½ä»¤ï¼Œèµ‹äº†éæ³•å€¼ç­‰ã€‚ä½†è¿™ç±»é”™è¯¯ä¸èƒ½å›æ»šæ•´ä¸ªäº‹åŠ¡ï¼Œè€Œæ˜¯ä¸€éƒ¨åˆ†æ‰§è¡ŒæˆåŠŸã€‚å› æ­¤å¼€å‘è€…éœ€è¦è‡ªè¡Œå¤„ç†è¿™ç±»é—®é¢˜ã€‚ä¹‹æ‰€ä»¥è¯´ Redis çš„äº‹åŠ¡æ˜¯ç®€å•çš„äº‹åŠ¡ï¼Œå°±åœ¨äºå®ƒä¸æ”¯æŒå›æ»šã€‚

æœ‰äº›åº”ç”¨åœºæ™¯éœ€è¦åœ¨äº‹åŠ¡ä¹‹å‰ç¡®ä¿äº‹åŠ¡ä¸­çš„ key æ²¡æœ‰è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹è¿‡æ‰æ‰§è¡Œäº‹åŠ¡ã€‚è¿™æ˜¯å¯ä»¥ç”¨ watch
å‘½ä»¤ã€‚

1. T1:Client1: `set key "java"`
2. T2:Client1: `watch key`
3. T3:Client1: `multi`
4. T4:**Client2**: `append key python`
5. T5:Client1: `append key jedis`
6. T6:Client1: `exec`
7. T7:Client1: `get key`

è¿™ä¼šå¯¼è‡´äº‹åŠ¡ä¸è¢«æ‰§è¡Œï¼Œæœ€åçš„ `get key` ç»“æœä¸º `"javapython"`

### 3.4.2 Luaç”¨æ³•ç®€è¿°

Lua åœ¨ Redis ä¸­å¯ä»¥å®šåˆ¶å‘½ä»¤ã€‚

#### 1.æ•°æ®ç±»å‹åŠå…¶é€»è¾‘å¤„ç†

- boolean
- number
- string
- table (æ ‡å“¥)

##### 1.1 å­—ç¬¦ä¸²

```lua
-- local è¡¨ç¤ºå±€éƒ¨å˜é‡ï¼Œæ²¡æœ‰çš„è¯å°±æ˜¯å…¨å±€å˜é‡
local strings hello = "world"
print(hello)
```

##### 1.2 æ•°ç»„

```lua
-- index ä» 1 å¼€å§‹ï¼Œè€Œä¸æ˜¯ 0
local tables myArray = {"redis", "jedis", true, 88.0}
print(myArray[3])
-- true
```

##### 1.3 for

```lua
local int sum = 0
for i = 1, 100
do
    sum = sum + i
end
print(sum)
```

```lua
-- # å–é•¿åº¦
for i = 1, #myArray
do
    print(myArray[i])
end
```

```lua
for index, value in ipairs(myArray)
do
    print(index)
    print(value)
end
```

##### 1.4 while

```lua
local int sum = 0
local int i = 0
while i <= 100
do
    sum = sum + i
    i = i + 1
end
print(sum)
```

##### 1.5 if else

```lua
local tables myArray = {"redis", "jedis", true, 88.0}
for i = 1, #myArray
do
    if myArray[i] == "jedis"
    then
        print("true")
        break
    else
        -- do nothing
    end
end
```

##### 1.6 å“ˆå¸Œ

```lua
local tables user_1 = {age = 28, name = "tome"}
-- .. è¿æ¥å­—ç¬¦ä¸²
print("user_1 age is " .. user_1["age"])
```

éå†

```lua
for key, value in pairs(user_1)
do print(key .. value)
end
```

#### 2.å‡½æ•°å®šä¹‰

```lua
function funcName()
    -- ...
end

function concat(str1, str2)
    return str1 .. str2
end

print(concat("hello ", "world"))
```

### 3.4.3 Redis ä¸ Lua

#### 1.åœ¨ Redis ä¸­ä½¿ç”¨ Lua

æœ‰ä¸¤ç§æ–¹æ³•ï¼š

- `eval`
- `evalsha`

##### 1.1 eval

```redis
# eval è„šæœ¬ KEYä¸ªæ•° KEYåˆ—è¡¨ å‚æ•°åˆ—è¡¨
eval 'return "hello " .. KEYS[1] .. ARGV[1]' 1 redis world
# "hello redisworld"
```

`redis-cli --eval` å¯ä»¥ç›´æ¥æ‰§è¡Œ Lua è„šæœ¬æ–‡ä»¶ã€‚

##### 1.2 evalsha

1. åŠ è½½ Lua è„šæœ¬åˆ° Redis
    - `redis-cli script load "$(cat script.lua)"`
2. Redis è®¡ç®—è„šæœ¬ SHA1 å€¼ï¼Œå¹¶ä½¿è„šæœ¬å¸¸é©»
3. è¿”å› SHA1 å€¼
4. `evalsha SHA1 KEYä¸ªæ•° KEYåˆ—è¡¨ å‚æ•°åˆ—è¡¨`

#### 2.Lua çš„ Redis API

Lua å¯ä»¥ä½¿ç”¨ `redis.call` å®ç°å¯¹ Redis çš„è®¿é—®

```lua
redis.call("set", "hello", "world")
redis.call("get", "hello")
```

ç›¸å½“äºåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ

```redis
eval 'return redis.call("get", KEYS[1])' 1 hello
```

Lua è¿˜å¯ä»¥ä½¿ç”¨ `redis.pcall` å®ç°å¯¹ Redis çš„è°ƒç”¨ï¼ŒåŒºåˆ«åœ¨äºå¦‚æœ `redis.call`
å¤±è´¥ï¼Œè„šæœ¬ä¼šç›´æ¥ç»“æŸè¿”å›é”™è¯¯ï¼Œè€Œ `redis.pcall` ä¼šå¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œã€‚

ğŸ’¡ Lua è¿˜å¯ä»¥ä½¿ç”¨ `redis.log` å°† Lua è„šæœ¬æ—¥å¿—è¾“å‡ºåˆ° Redis çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä½†ä¸€å®šè¦æ§åˆ¶æ—¥å¿—çº§åˆ«ã€‚Redis è¿˜æä¾›äº† Lua Script Debugger åŠŸèƒ½æ¥è°ƒè¯•å¤æ‚çš„ Lua è„šæœ¬

### 3.4.4 æ¡ˆä¾‹

Lua è„šæœ¬çš„ä¸‰ä¸ªä¸»è¦å¥½å¤„ï¼š

1. åœ¨ Redis ä¸­æ˜¯åŸå­æ‰§è¡Œçš„ï¼Œä¸­é—´ä¸ä¼šæ’å…¥å…¶ä»–å‘½ä»¤
2. å¯ä»¥å®šåˆ¶åŒ–å‘½ä»¤ï¼Œå¹¶å¸¸é©»å†…å­˜å®ç°å¤ç”¨
3. å¯ä»¥æ‰“åŒ…å¤šæ¡ Redis å‘½ä»¤ï¼Œå‡å°‘ç½‘ç»œå¼€é”€

ä¾‹å­ï¼šå½“å‰åˆ—è¡¨è®°å½•ç€çƒ­é—¨ç”¨æˆ·çš„ idï¼Œç°è¦å¯¹åˆ—è¡¨å†…æ‰€æœ‰çš„é”®å¯¹åº”çƒ­åº¦åš +1 æ“ä½œï¼Œå¹¶ä¸”ä¿è¯æ˜¯åŸå­æ‰§è¡Œã€‚

```redis
lrange hot:user:list 0 -1
# "user:1:ratio"
# "user:8:ratio"
# "user:3:ratio"
# "user:99:ratio"
# "user:72:ratio"

mset user:1:ratio 968 user:8:ratio 762 user:3:ratio 556 user:99:ratio 400 user:72:ratio 101
mget user:1:ratio user:8:ratio user:3:ratio user:99:ratio user:72:ratio
# 968
# 762
# 556
# 400
# 101
```

```lua
-- lrange_and_mincr.lua
local mylist = redis.call("lrange", KEYS[1], 0, -1)
local count = 0

for index,key in ipairs(mylist)
do
    redis.call("incr", key)
    count = count + 1
end
return count
```

```sh
redis-cli --eval lrange_and_mincr.lua hot:user:list
```

### 3.4.5 Redis å¦‚ä½•ç®¡ç† Lua è„šæœ¬

- `script load script.lua`
- `script exists sha1 [sha1 ...]`: è¿”å›çš„æ•°å­— sha1 æœ‰æ•ˆè„šæœ¬æ•°é‡
- `script flush`: æ¸…é™¤å·²åŠ è½½çš„è„šæœ¬
- `script kill`: æ€æ‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬

Redis æä¾›äº†ä¸€ä¸ª `lua-time-limit` å‚æ•°ï¼Œé»˜è®¤ 5sï¼Œå®ƒæ˜¯ Lua è„šæœ¬çš„è¶…æ—¶æ—¶é—´ã€‚ä½†è¿™ä¸ªè¶…æ—¶æ—¶é—´ä»…ä»…æ˜¯åœ¨è¶…æ—¶åï¼Œå‘å…¶ä»–å‘½ä»¤è°ƒç”¨å‘é€ `BUSY` ä¿¡å·ï¼Œè€Œä¸ä¼šåœæ‰æ­£åœ¨æ‰§è¡Œçš„è„šæœ¬ã€‚

è¿™æ—¶å¯ä»¥ç­‰å¾…æˆ–è€…ä½¿ç”¨ `script kill`ã€‚âš ï¸ å¦‚æœè„šæœ¬æ­£åœ¨æ‰§è¡Œå†™æ“ä½œï¼Œåˆ™ `script kill` ä¸ä¼šç”Ÿæ•ˆã€‚

## 3.5 Bitmaps

### 3.5.1 æ•°æ®ç»“æ„æ¨¡å‹

- Bitmaps æœ¬èº«ä¸æ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå®é™…ä¸Šå®ƒå°±æ˜¯å­—ç¬¦ä¸²ï¼Œä½†æ˜¯å®ƒå¯ä»¥å¯¹å­—ç¬¦ä¸²çš„ä½è¿›è¡Œæ“ä½œ
- Bitmaps å•ç‹¬æä¾›äº†ä¸€å¥—å‘½ä»¤ï¼Œæ‰€ä»¥ä½¿ç”¨ Bitmaps å’Œä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹æ³•ä¸åŒã€‚
  - å¯ä»¥æŠŠ Bitmaps æƒ³è±¡æˆä¸€ä¸ªä»¥ä½ä¸ºå•ä½çš„æ•°ç»„ï¼Œæ•°ç»„æ¯ä¸ªå…ƒç´ åªèƒ½æ˜¯ 0 æˆ– 1ï¼Œæ•°ç»„çš„ä¸‹æ ‡åœ¨
    Bitmaps ä¸­å«åç§»é‡ã€‚

### 3.5.2 å‘½ä»¤

ä¾‹å­ï¼šå°†æ¯ä¸ªç‹¬ç«‹ç”¨æˆ·æ˜¯å¦è®¿é—®è¿‡ç½‘ç«™å­˜æ”¾åœ¨ Bitmaps ä¸­ï¼Œè®¿é—®çš„è®°ä¸º 1ï¼Œæ²¡è®¿é—®çš„è®°ä¸º 0ï¼Œåç§»é‡ä¸ºç”¨æˆ·çš„ idã€‚

#### 1.è®¾ç½®å€¼

```redis
setbit key offset value

setbit unique:users:date 0 1
setbit unique:users:date 5 1
setbit unique:users:date 11 1
setbit unique:users:date 15 1
setbit unique:users:date 19 1
```

âš ï¸ åœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ– Bitmaps æ—¶ï¼Œå¦‚æœåç§»é‡å·¨å¤§ï¼Œè¿™ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ä¼šæ¯”è¾ƒæ…¢è€Œé€ æˆé˜»å¡ã€‚

#### 2.è·å–å€¼

```redis
getbit key offset

getbit unique:users:date 0
```

#### 3.è·å– Bitmaps æŒ‡å®šèŒƒå›´å€¼ä¸º 1 çš„ä¸ªæ•°

```redis
bitcount [start][end] # å­—èŠ‚æ•°

bitcount unique:users:date
bitcount unique:users:date 2 2
```

#### 4.Bitmaps é—´çš„è¿ç®—

bitop æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼Œå¯ä»¥åšå¤šä¸ª Bitmaps çš„ and, or, not, xor ç­‰æ“ä½œå¹¶ä¿å­˜åœ¨ `destkey`
ä¸­ã€‚

```redis
bitop op destkey key [key...]

# è·å– 2016-04-04 å’Œ 2016-04-03 è¿™ä¸¤å¤©ä¸­è®¿é—®è¿‡ç½‘ç«™çš„ç”¨æˆ·æ•°
bitop or unique:users:or:2016-04-04_03 unique:users:2016-04-03 unique:users:2016-04-04
```

#### 5.è®¡ç®— Bitmaps ä¸­ç¬¬ä¸€ä¸ªå€¼ä¸º targetBit çš„åç§»é‡

```redis
bitpos key targetBit [start][end]

# æŸ¥è¯¢è®¿é—®ç½‘ç«™çš„æœ€å°ç”¨æˆ· id
bitpos unique:users:date 1
bitpos unique:users:date 1 1
```

### 3.5.3 Bitmaps åˆ†æ

å‡è®¾ç½‘ç«™æœ‰ 1 äº¿ç”¨æˆ·ï¼Œæ¯å¤©ç‹¬ç«‹è®¿é—®ç”¨æˆ·æœ‰ 5 åƒä¸‡ï¼Œå¦‚æœæ¯å¤©ç”¨é›†åˆç±»å‹å’Œ Bitmaps åˆ†åˆ«å­˜å‚¨æ´»è·ƒç”¨æˆ·ï¼š

é›†åˆç±»å‹:

- ç”¨æˆ· id å ç”¨ç©ºé—´ï¼š64 bits (8 bytes)
- éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ï¼š50,000,000
- å†…å­˜é‡ï¼š`64bits * 50,000,000 = 400MB`

Bitmaps:

- ç”¨æˆ· id å ç”¨ç©ºé—´ï¼š1 bit
- éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ï¼š100,000,000
- å†…å­˜é‡ï¼š`1bit * 100,000,000 = 12.5MB`

ä½†å¦‚æœè¿™ä¸ªç½‘ç«™æ¯å¤©çš„ç‹¬ç«‹è®¿é—®ç”¨æˆ·å¾ˆå°‘ï¼Œåªæœ‰ 10 ä¸‡ï¼Œè¿™æ—¶å€™ç”¨ Bitmaps å°±ä¸å¤ªé€‚åˆäº†ï¼š

é›†åˆç±»å‹:

- éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ï¼š100,000
- å†…å­˜é‡ï¼š`64bits * 100,000 = 800KB`

Bitmaps:

- éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ï¼š100,000,000
- å†…å­˜é‡ï¼š`1bit * 100,000,000 = 12.5MB`

## 3.6 HyperLogLog

HyperLogLog ä¹Ÿä¸æ˜¯ä¸€ç§æ–°çš„æ•°æ®ç»“æ„ï¼ˆå®é™…ç±»å‹ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼‰ï¼Œè€Œæ˜¯ä¸€ç§åŸºæ•°ç®—æ³•ï¼Œåˆ©ç”¨æå°çš„å†…å­˜ç©ºé—´å®Œæˆç‹¬ç«‹æ€»æ•°çš„ç»Ÿè®¡ï¼Œæ•°æ®é›†å¯ä»¥æ˜¯ IP, Email, ID ç­‰ã€‚HyperLogLog æä¾›äº† 3 ä¸ªå‘½ä»¤ï¼š

- `pfadd`
- `pfcount`
- `pfmerge`

ä¸¾ä¾‹ï¼š

- 2016-03-06 çš„è®¿é—®ç”¨æˆ·æœ‰
  - uuid-1
  - uuid-2
  - uuid-3
  - uuid-4
- 2016-03-05
  - uuid-4
  - uuid-5
  - uuid-6
  - uuid-7

### 1.æ·»åŠ 

```redis
pfadd key element [element ...]

pfadd 2016_03_06:unique:ids "uuid-1" "uuid-2" "uuid-3" "uuid-4"
pfadd 2016_03_05:unique:ids "uuid-4" "uuid-5" "uuid-6" "uuid-7"
```

### 2.è®¡ç®—ç‹¬ç«‹ç”¨æˆ·æ•°

```redis
pfcount key [key ...]

pfcount 2016_03_06:unique:ids
pfcount 2016_03_05:unique:ids
```

ä½¿ç”¨è„šæœ¬å‘ HyperLogLog æ’å…¥ 100 ä¸‡ä¸ª id

```redis
info memory
# used_memory:861696
# used_memory_human:841.50K
```

```sh
elements=""
key="2016_05_01:unique:ids"
for i in `seq 1 1000000`
do
    elements="${elements} uuid-"${i}
    if [[ $((i%1000)) == 0 ]];
    then
        redis-cli pfadd ${key} ${elements}
        elements=""
    fi
done
```

æ‰§è¡Œåï¼Œå†…å­˜åªå¢åŠ äº† 15KB å·¦å³ã€‚ä¸è¿‡ï¼Œç”¨ `pfcount` çš„ç»Ÿè®¡ç»“æœå¹¶ä¸æ˜¯ç²¾ç¡®çš„ 100ä¸‡

```redis
pfcount 2016_05_01:unique:ids
# 1009838
```

å¦‚æœæ˜¯ç”¨é›†åˆç±»å‹å­˜å‚¨ 100 ä¸‡ä¸ª uuid

```sh
elements=""
key="2016_05_01:unique:ids:set"
for i in `seq 1 1000000`
do
    elements="${elements} "${i}
    if [[ $((i%1000)) == 0 ]];
    then
        redis-cli sadd ${key} ${elements}
        elements=""
    fi
done
```

ä½¿ç”¨é›†åˆå ç”¨çš„å†…å­˜è¾¾åˆ° 84MBï¼Œä½†æ˜¯ç»Ÿè®¡æ•°é‡æ˜¯ç²¾ç¡®çš„

```redis
scard 2016_05_01:unique:ids:set
# 1000000
```

### 3.åˆå¹¶

```redis
pfmerge destkey sourcekey [sourcekey ...]
```

`pfmerge` å¯ä»¥æ±‚å‡ºå¤šä¸ª HyperLogLog çš„å¹¶é›†å¹¶èµ‹å€¼ç»™ `destkey`

ä¾‹å¦‚è¦æ±‚å‡º 2016-03-06 å’Œ 2016-03-05 çš„è®¿é—®ç‹¬ç«‹ç”¨æˆ·æ•°ï¼›

```redis
pfmerge 2016_03_05_06:unique:ids 2016_03_05:unique:ids 2016_03_06:unique:ids
pfcount 2016_03_05_06:unique:ids
# 7
```

ä½¿ç”¨ HyperLogLog çš„åŸåˆ™ï¼š

- åªä¸ºäº†è®¡ç®—ç‹¬ç«‹æ€»æ•°ï¼Œä¸éœ€è¦è·å–å•æ¡æ•°æ®
- å¯ä»¥å®¹å¿ä¸€å®šçš„è¯¯å·®ç‡ï¼ŒRedis å®˜æ–¹ç»™å‡ºçš„å¤±è¯¯ç‡ä¸º 0.81%

## 3.7 å‘å¸ƒè®¢é˜…

### 3.7.1 å‘½ä»¤

#### 1.å‘å¸ƒæ¶ˆæ¯

```redis
publish channel message

publish channel:sports "Tim won the championship"
```

#### 2.è®¢é˜…æ¶ˆæ¯

```redis
subscribe channel [channel ...]

subscribe channel:sports
```

è®¢é˜…å‘½ä»¤æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š

- å®¢æˆ·ç«¯åœ¨æ‰§è¡Œè®¢é˜…å‘½ä»¤ä¹‹åè¿›å…¥äº†è®¢é˜…çŠ¶æ€ï¼Œåªèƒ½æ¥æ”¶ subscribe, psubscribe, unsubscribe,
  punsubscribe çš„å››ä¸ªå‘½ä»¤ã€‚
- æ–°å¼€å¯çš„è®¢é˜…å®¢æˆ·ç«¯æ— æ³•æ”¶åˆ°æ­¤å‰çš„æ¶ˆæ¯ï¼Œå› ä¸º Redis æ²¡æœ‰å¯¹å‘å¸ƒçš„æ¶ˆæ¯åšæŒä¹…åŒ–

ğŸ”” å’Œå¾ˆå¤šä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ˆKafka, RocketMQï¼‰ç›¸æ¯”ï¼ŒRedis çš„å‘å¸ƒè®¢é˜…ç›¸å¯¹ç²—ç³™ï¼Œ
æ— æ³•å®ç°æ¶ˆæ¯å †ç§¯å’Œå›æº¯ã€‚ä¸è¿‡å¦‚æœåœºæ™¯ç›¸å¯¹ç®€å•ï¼Œè¿˜æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

#### 3.å–æ¶ˆè®¢é˜…

```redis
unsubscribe [channel [channel ...]]
unsubscribe channel:sports
```

#### 4.æŒ‰ç…§æ¨¡å¼è®¢é˜…å’Œå–æ¶ˆè®¢é˜…

è¿™é‡Œçš„ pattern æ˜¯ glob é£æ ¼ã€‚

```redis
psubscribe pattern [pattern ...]
punsubscribe [pattern [pattern ...]]

psubscribe it*
```

#### 5.æŸ¥è¯¢è®¢é˜…

##### 5.1 æŸ¥çœ‹æ´»è·ƒçš„é¢‘é“

```redis
pubsub channels [pattern]
```

æ´»è·ƒé¢‘é“æ˜¯æŒ‡è‡³å°‘æœ‰ä¸€ä¸ªè®¢é˜…è€…çš„é¢‘é“ã€‚

##### 5.2 æŸ¥çœ‹é¢‘é“è®¢é˜…æ•°

```redis
pubsub numsub [channel ...]

pubsub numsub channel:sports
```

##### 5.3 æŸ¥çœ‹æ¨¡å¼è®¢é˜…æ•°

```redis
pubsub numpat
```

### 3.7.2 ä½¿ç”¨åœºæ™¯

èŠå¤©å®¤ã€å…¬å‘Šç‰Œã€æœåŠ¡ä¹‹é—´åˆ©ç”¨æ¶ˆæ¯è§£è€¦éƒ½å¯ä»¥ä½¿ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼ã€‚

```mermaid
flowchart TD

user[User]--æ›´æ–°è§†é¢‘-->vms[Video Management System]
vms--è§†é¢‘å˜æ›´æ¶ˆæ¯-->r[Redis è§†é¢‘å˜æ›´é¢‘é“]
vs1[è§†é¢‘æœåŠ¡ 1]--è®¢é˜…-->r
vs2[è§†é¢‘æœåŠ¡ 2]--è®¢é˜…-->r
vs3[è§†é¢‘æœåŠ¡ 3]--è®¢é˜…-->r
```

è§†é¢‘æœåŠ¡è®¢é˜… `video:changes` é¢‘é“ï¼š

```redis
subscribe video:changes
```

è§†é¢‘ç®¡ç†ç³»ç»Ÿå‘å¸ƒæ¶ˆæ¯åˆ° `video:changes` é¢‘é“ï¼š

```redis
publish video:changes "video1, video3, video5"
```

å½“è§†é¢‘æœåŠ¡æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±å¯ä»¥å¯¹è§†é¢‘ä¿¡æ¯è¿›è¡Œæ›´æ–°ï¼š

```sh
for video in video1, video3, video5
    update {video}
```

## 3.8 GEO

GEO (geospatial) åœ°ç†ä¿¡æ¯å®šä½åŠŸèƒ½ï¼Œæ”¯æŒå­˜å‚¨åœ°ç†ä½ç½®ä¿¡æ¯ï¼Œç”¨äºå®ç°è¯¸å¦‚é™„è¿‘ä½ç½®ã€æ‘‡ä¸€æ‘‡è¿™ç±»ä¾èµ–åœ°ç†ä½ç½®ä¿¡æ¯çš„åŠŸèƒ½ã€‚Redis çš„ GEO å€Ÿé‰´ NoSQL æ•°æ®åº“ Ardb å®ç°çš„ã€‚

### 1.å¢åŠ åœ°ç†ä½ç½®ä¿¡æ¯

```redis
geoadd key longitude latitude member [longitude latitude member ...]

# æ›´æ–°ä¹Ÿæ˜¯ç”¨ geoadd, ä»¥ member ä¸ºä¾æ®ï¼Œå¦‚æœä¸å­˜åœ¨å°±å¢åŠ ï¼Œå¹¶è¿”å› 1ï¼Œå¦åˆ™æ›´æ–°ï¼Œè¿”å› 0
geoadd cities:locations 116.28 39.55 beijing
geoadd cities:locations 117.12 39.08 tianjin
```

### 2.è·å–åœ°ç†ä½ç½®ä¿¡æ¯

```redis
geopos key member [member ...]

geopos cities:locations beijing
```

### 3.è·å–ä¸¤ä¸ªåœ°ç†ä½ç½®çš„è·ç¦»

```redis
geodist key member1 member2 [unit]

geodist cities:locations tianjin beijing km
```

å•ä½æœ‰

- m
- km
- mi (miles)
- ft (feet)

### 4.è·å–æŒ‡å®šä½ç½®èŒƒå›´å†…çš„åœ°ç†ä¿¡æ¯ä½ç½®é›†åˆ

```redis
georadius key longitude latitude radius m|km|ft|mi [withcoord] [withdist]
    [withhash] [COUNT count] [asc|desc] [store key] [storedist key]
georadiusbymember key member     radius m|km|ft|mi [withcoord] [withdist]
    [withhash] [COUNT count] [asc|desc] [store key] [storedist key]
```

è¿™ä¸¤ä¸ªå‘½ä»¤éƒ½æ˜¯ä»¥ä¸€ä¸ªåœ°ç†ä½ç½®ä¸ºä¸­å¿ƒç®—å‡ºæŒ‡å®šåŠå¾„å†…çš„å…¶ä»–åœ°ç†ä½ç½®ä¿¡æ¯

- georadius ç»™å‡ºå…·ä½“ç»çº¬åº¦
- georadiusbymember ç»™å‡ºæˆå‘˜

å¯é€‰å‚æ•°ï¼š

- withcoord: è¿”å›ç»“æœä¸­åŒ…å«ç»çº¬åº¦
- withdist: è¿”å›ç»“æœä¸­åŒ…å«ç¦»ä¸­å¿ƒèŠ‚ç‚¹ä½ç½®çš„è·ç¦»
- withhash: è¿”å›ç»“æœä¸­åŒ…å« geohash
- COUNT count: æŒ‡å®šè¿”å›ç»“æœçš„æ•°é‡
- asc|desc: æŒ‰è·ç¦»ä¸­å¿ƒèŠ‚ç‚¹çš„è·ç¦»åšå‡åºæˆ–è€…é™åº
- store key: å°†è¿”å›ç»“æœçš„åœ°ç†ä½ç½®ä¿¡æ¯ä¿å­˜åˆ°æŒ‡å®šé”®
- storedist key: å°†è¿”å›ç»“æœç¦»ä¸­å¿ƒèŠ‚ç‚¹çš„è·ç¦»ä¿å­˜åˆ°æŒ‡å®šé”®

```redis
georadiusbymember cities:locations bejing 150 km
# 1) "beijing"
# 2) "tianjin"
# 3) "tangshan"
# 4) "baoding"
```

### 5.è·å– geohash

Redis ä½¿ç”¨ geohash å°†äºŒç»´ç»çº¬åº¦è½¬æ¢ä¸ºä¸€ç»´çš„å­—ç¬¦ä¸²ï¼š

```redis
geohash key member [member ...]

geohash cities:locations beijing
```

geohash çš„ç‰¹ç‚¹ï¼š

- GEO æ•°æ®ç±»å‹ä¸º zsetï¼ŒRedis å°†æ‰€æœ‰åœ°ç†ä½ç½®ä¿¡æ¯çš„ geohash å­˜æ”¾åœ¨ zset ä¸­
  - `type cities:locations`
- å­—ç¬¦ä¸²è¶Šé•¿ï¼Œè¡¨ç¤ºçš„ä½ç½®æ›´ç²¾ç¡®ã€‚å¦‚ä¸‹ä¸º geohash é•¿åº¦å’Œç²¾ç¡®åº¦ (km) çš„å…³ç³»
  - 1: 2500
  - 2: 630
  - 3: 78
  - 4: 20
  - 5: 2.4
  - 6: 0.61
  - 7: 0.076
  - 8: 0.019
  - 9: 0.002
- ä¸¤ä¸ªå­—ç¬¦ä¸²è¶Šç›¸ä¼¼ï¼Œå®ƒä»¬ä¹‹é—´çš„è·ç¦»è¶Šè¿‘ï¼ŒRedis åˆ©ç”¨å­—ç¬¦ä¸²å‰ç¼€åŒ¹é…ç®—æ³•å®ç°ç›¸å…³çš„å‘½ä»¤
- geohash ç¼–ç å’Œç»çº¬åº¦å¯ä»¥äº’ç›¸è½¬æ¢

Redis ä½¿ç”¨æœ‰åºé›†åˆç»“åˆ geohash ç‰¹æ€§å®ç°äº† GEO çš„è‹¥å¹²å‘½ä»¤

### 6.åˆ é™¤åœ°ç†ä½ç½®ä¿¡æ¯

GEO æ²¡æœ‰æä¾›åˆ é™¤æˆå‘˜çš„å‘½ä»¤ï¼Œä½†å› ä¸ºå®ƒåº•å±‚å®ç°æ˜¯ zsetï¼Œæ‰€ä»¥å¯ä»¥å€ŸåŠ© zrem å‘½ä»¤åˆ é™¤ã€‚

```redis
zrem key member
```

## 3.9 æœ¬ç« é‡ç‚¹å›é¡¾

1. æ…¢æŸ¥è¯¢ä¸­çš„ä¸¤ä¸ªé‡è¦å‚æ•° `slowlog-log-slower-than` å’Œ `slowlog-max-len`ã€‚
2. æ…¢æŸ¥è¯¢ä¸åŒ…å«å‘½ä»¤ç½‘ç»œä¼ è¾“å’Œæ’é˜Ÿæ—¶é—´ã€‚
3. æœ‰å¿…è¦å°†æ…¢æŸ¥è¯¢å®šæœŸå­˜æ”¾ã€‚
4. `redis-cli` ä¸€äº›é‡è¦çš„é€‰é¡¹ï¼Œä¾‹å¦‚ `--latency`ã€`â€“-bigkeys`ã€`-i` å’Œ `-r` ç»„åˆã€‚
5. `redis-benchmark` çš„ä½¿ç”¨æ–¹æ³•å’Œé‡è¦å‚æ•°ã€‚
6. Pipeline å¯ä»¥æœ‰æ•ˆå‡å°‘ RTT æ¬¡æ•°ï¼Œä½†æ¯æ¬¡ Pipeline çš„å‘½ä»¤æ•°é‡ä¸èƒ½æ— èŠ‚åˆ¶ã€‚
7. Redis å¯ä»¥ä½¿ç”¨ Lua è„šæœ¬åˆ›é€ å‡ºåŸå­ã€é«˜æ•ˆã€è‡ªå®šä¹‰å‘½ä»¤ç»„åˆã€‚
8. Redis æ‰§è¡Œ Lua è„šæœ¬æœ‰ä¸¤ç§æ–¹æ³•: `eval` å’Œ `evalsha`ã€‚
9. Bitmaps å¯ä»¥ç”¨æ¥åšç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡ï¼Œæœ‰æ•ˆèŠ‚çœå†…å­˜ã€‚
10. Bitmaps ä¸­ setbit ä¸€ä¸ªå¤§çš„åç§»é‡ï¼Œç”±äºç”³è¯·å¤§é‡å†…å­˜ä¼šå¯¼è‡´é˜»å¡ã€‚
11. HyperLogLog è™½ç„¶åœ¨ç»Ÿè®¡ç‹¬ç«‹æ€»é‡æ—¶å­˜åœ¨ä¸€å®šçš„è¯¯å·®ï¼Œä½†æ˜¯èŠ‚çœçš„å†…å­˜é‡ååˆ†æƒŠäººã€‚
12. Redis çš„å‘å¸ƒè®¢é˜…æœºåˆ¶ç›¸æ¯”è®¸å¤šä¸“ä¸šçš„æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»ŸåŠŸèƒ½è¾ƒå¼±ï¼Œä¸å…·å¤‡å †ç§¯å’Œå›æº¯æ¶ˆæ¯çš„èƒ½åŠ›ï¼Œä½†èƒœåœ¨è¶³å¤Ÿç®€å•ã€‚
13. Redis3.2 æä¾›äº† GEO åŠŸèƒ½ï¼Œç”¨æ¥å®ç°åŸºäºåœ°ç†ä½ç½®ä¿¡æ¯çš„åº”ç”¨ï¼Œåº•å±‚å®ç°æ˜¯ zsetã€‚
