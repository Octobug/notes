# Cross Platform

- [Cross Platform](#cross-platform)
  - [Compiler](#compiler)
    - [编译器的选择](#编译器的选择)
    - [编译警告](#编译警告)
    - [交叉编译](#交叉编译)
  - [Syntax](#syntax)
    - [标准未定义](#标准未定义)
    - [其他](#其他)
  - [Exception](#exception)
  - [Hardware](#hardware)
  - [Operating System](#operating-system)
    - [文件系统](#文件系统)
    - [回车换行](#回车换行)
    - [文件搜索路径](#文件搜索路径)
    - [环境变量](#环境变量)
    - [动态库](#动态库)
    - [服务/守护进程](#服务守护进程)
    - [默认栈大小](#默认栈大小)
  - [多线程](#多线程)
    - [编译器](#编译器)
      - [C 运行库 (C Run-Time) 选项](#c-运行库-c-run-time-选项)
      - [关于优化选项](#关于优化选项)
      - [线程库的选择](#线程库的选择)
    - [权衡不同的库](#权衡不同的库)
    - [编程上的注意事项](#编程上的注意事项)

## Compiler

### 编译器的选择

- GCC
- 本地编译器（即操作系统厂商提供的编译器）
  - Visual C++ (Windows)
  - CC (Solaris)

### 编译警告

- 调高编译器警告级别
- 小心对待编译警告信息

### 交叉编译

即在 A 平台编译出运行在 B 平台的二进制程序。一般选择 GCC。

## Syntax

### 标准未定义

- 不使用全局类对象，改用单键；
- 不依赖函数参数的求值顺序；
- 不定义参数类型相近的函数
- 不依赖标准类型的字长

### 其他

- 保持 inline 函数尽量简单

## Exception

- 处理异常：new 分配内存失败
- 慎用异常规格
- 不跨模块抛出异常
- 不使用结构化异常处理
- 不指望 catch 捕获非 C++ 异常

## Hardware

- 基本类型大小：使用 `sizeof()` 确定字节数；
- 字节序；
- 内存对齐；
- 移位操作：尽量少用。

## Operating System

### 文件系统

- 文件命名规范
- 尽量用流行的第三方库

### 回车换行

- Windows: `CRLF`
- Unix/Linux: `LF`
- macOS: `CR`

### 文件搜索路径

### 环境变量

### 动态库

- 动态库导出函数
- 符号表

### 服务/守护进程

### 默认栈大小

- 不在栈上定义大数组/大对象

## 多线程

### 编译器

#### C 运行库 (C Run-Time) 选项

大部分 C++ 编译器都自带有 CRT（可能不止一个）。
某些编译器自带的 CRT 会根据线程的支持分为“单线程 CRT”和“多线程 CRT”两类。
当要进行多线程开发时，要确保相关的 C++ 工程项目使用的是多线程 CRT。

#### 关于优化选项

某些优化选项可能会有潜在风险。编译器可能打乱执行指令的顺序，导致出乎意料的线程条件竞争问题
(Race Condition)。建议只使用编译器常规的速度优化选项。

以 GCC 为例：建议 `-O2` 选项（一堆选项的集合），没必要冒险用 `-O3`。

#### 线程库的选择

C++ 03 标准几乎没有涉及线程相关的内容，跨平台的多线程支持依赖第三方库。

- ACE (Adaptive Communication Environment)
  - 支持互斥锁 (ACE_Mutex)
    - 线程读写锁 (ACE_RW_Thread_Mutex)
    - 线程递归锁 (ACE_Recursive_Thread_Mutex)
  - 条件变量 (ACE_Condition)
  - 信号量 (ACE_Semaphore)
  - 栅栏 (ACE_Barrier)
  - 原子操作 (ACE_Atomic_Op) 等。
  - 优点：对各种操作系统平台及其自带的编译器支持很好。
  - 缺点：ACE 开发于上世纪九十年代中期，那时很多 C++ 的老特性都还没出来，所以 ACE
    的风格有些老气。
- `boost::thread`
  - 优点：发展很快，有很多 C++ 标准委员会的成员在 boost 社区中。
  - 缺点：支持的编译器不够多，尤其是一些老式编译器。
- wxWidgets 和 QT
  - wxWidgets 和 QT 都是 GUI 界面库，但是都内置和对线程的支持，都提供 `mutex`,
    `condition`, `semaphore` 等常用机制。不过没有 ACE 丰富。

### 权衡不同的库

- 对于 GUI 软件，且已经用上 wxWidgets 或者 QT 的，可以直接用它们的线程库，不过它们的特性比较单薄。
  如果需要高级的线程功能，就得考虑换成 `boost::thread` 或 ACE。
- 至于 `boost::thread` 和 ACE 的取舍，就看需要支持的平台的情况。

### 编程上的注意事项

- `volatile`
- 原子操作：多个线程的竞争写需要加锁，多个读单个写也需要保护。
- 对象的析构：确保所有线程都能够自然死亡。
