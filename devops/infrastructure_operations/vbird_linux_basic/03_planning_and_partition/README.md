# 第三章、主机规划与磁盘分区

> <http://cn.linux.vbird.org/linux_basic/0130designlinux.php>

## 目录

- [第三章、主机规划与磁盘分区](#第三章主机规划与磁盘分区)
  - [目录](#目录)
  - [1. Linux 与硬件的搭配](#1-linux-与硬件的搭配)
    - [1.1 认识计算机的硬件配备](#11-认识计算机的硬件配备)
    - [1.2 选择与 Linux 搭配的主机配备：硬件支持相关网站](#12-选择与-linux-搭配的主机配备硬件支持相关网站)
    - [1.3 各硬件设备在 Linux 中的文件名](#13-各硬件设备在-linux-中的文件名)
  - [2. 磁盘分区](#2-磁盘分区)
    - [2.1 磁碟连接的方式与设备文件名的关系](#21-磁碟连接的方式与设备文件名的关系)
    - [2.2 磁碟的组成复习](#22-磁碟的组成复习)
    - [2.3 磁盘分区表 (partition table)](#23-磁盘分区表-partition-table)
    - [2.4 启动流程与主要启动记录区(MBR)](#24-启动流程与主要启动记录区mbr)
    - [2.5 Linux 安装模式下，磁盘分区的选择 (极重要)](#25-linux-安装模式下磁盘分区的选择-极重要)
  - [3. 安装 Linux 前的规划](#3-安装-linux-前的规划)
    - [3.1 选择适当的 distribution](#31-选择适当的-distribution)
    - [3.2 主机的服务规划与硬件的关系](#32-主机的服务规划与硬件的关系)
    - [3.3 主机硬盘的主要规划 (partition)](#33-主机硬盘的主要规划-partition)
    - [3.4 鸟哥说：关於练习机的安装建议](#34-鸟哥说关於练习机的安装建议)
    - [3.5 鸟哥的两个实际案例](#35-鸟哥的两个实际案例)
    - [3.6 大硬盘配合旧主机造成的无法启动问题](#36-大硬盘配合旧主机造成的无法启动问题)
  - [4. 重点回顾](#4-重点回顾)
  - [5. 本章习题](#5-本章习题)
  - [6. 参考数据与延伸阅读](#6-参考数据与延伸阅读)
  - [7. 针对本文的建议](#7-针对本文的建议)

## 1. Linux 与硬件的搭配

### 1.1 认识计算机的硬件配备

- 游戏机/工作机的考量：显卡、CPU；
- 效能/价格比的考量：主流级产品效能/价格比通常较好；同时还可以考虑『每瓦效能』；
- 支持度的考量：特别注意该硬件是否有针对您的操作系统提供适当的驱动程序。

### 1.2 选择与 Linux 搭配的主机配备：硬件支持相关网站

- CPU
- RAM
- Hard Disk
- VGA
- Network Interface Card
- 光盘、软盘、键盘与鼠标：这些配备都是非必备的，安装好的服务器通常只有网络线连接在计算机后面，
  其他的都是透过网络连线来管控的。

### 1.3 各硬件设备在 Linux 中的文件名

『在 Linux 系统中，每个设备都被当成一个文件来对待』比如 IDE 接口的硬盘的文件名称即为
`/dev/hd[a-d]`，其中括号内的字母为 a-d 当中的任意一个，亦即有 `/dev/hda`, `/dev/hdb`,
`/dev/hdc`, 及 `/dev/hdd` 这四个文件的意思。

Tips:

> 在 Linux 系统中，几乎所有的硬件设备文件都在 `/dev` 这个目录内。

打印机与软盘分别是 `/dev/lp0`, `/dev/fd0`。底下列出几个常见的设备与其在 Linux
当中的文件名：

| 设备                   | 文件名                                         |
| ---------------------- | ---------------------------------------------- |
| IDE 硬盘               | `/dev/hd[a-d]`                                 |
| SCSI/SATA/移动硬盘/U盘 | `/dev/sd[a-p]`                                 |
| 软盘机                 | `/dev/fd[0-1]`                                 |
| 打印机                 | 25针: `/dev/lp[0-2]`, USB: `/dev/usb/lp[0-15]` |
| 鼠标                   | USB: `/dev/usb/mouse[0-15]`, PS2: `/dev/psaux` |
| 当前 CDROM/DVDROM      | `/dev/cdrom`                                   |
| 当前鼠标               | `/dev/mouse`                                   |
| 磁带机                 | IDE: `/dev/ht0`, SCSI: `/dev/st0`              |

硬盘 (不论是 IDE/SCSI/U盘都一样)，每个磁碟机的磁盘分区 (partition) 不同时，
其磁盘文件名还会改变。需要特别注意的是磁带机的文件名在某些不同的 distribution
当中可能会不一样。

Tips:

> 更多 Linux 核心支持的硬件设备与文件名: <https://www.kernel.org/doc/html/latest/admin-guide/devices.html>

## 2. 磁盘分区

一块磁盘可以被分割成多个分区 (partition)，在 Windows 中对应 C:, D:, E:...

### 2.1 磁碟连接的方式与设备文件名的关系

对于 IDE 接口，通常主机都会提供两个 IDE 接口，每个 IDE 排线可以连接两个 IDE 设备，
因此最多可以接四个 IDE 设备。对于这四个 IDE 设备其文件名为：

| IDE\Jumper       | Master     | Slave      |
| ---------------- | ---------- | ---------- |
| IDE1 (Primary)   | `/dev/hda` | `/dev/hdb` |
| IDE2 (Secondary) | `/dev/hdc` | `/dev/hdd` |

假设有一个 IDE 磁盘接在 IDE2 的 Master 上面，则它的 Linux 设备文件名为 `/dev/hdc`。

对于 SATA 接口，由於 SATA/U盘/SCSI 等磁盘接口都是使用 SCSI 模块驱动，
因此这些接口的磁盘设备名都是 `/dev/sd[a-p]` 的格式。与 IDE 接口不同，SATA/U盘
接口的磁盘根本就没有顺序，那如何决定它的设备文件名呢？—— 根据 Linux 内核检测到磁盘的顺序。

如果你的 PC 有两个 SATA 磁盘及一个 U盘，而主板上面有六个 SATA 插槽。这两个 SATA
磁盘分别安插在主板上的 SATA1, SATA5 插槽上，请问这三个磁碟在 Linux 中的装置档名为何？

由於是使用侦测到的顺序来决定设备文件名，并非与实际插槽代号有关，因此设备文件名如下：

- SATA1 插槽上的文件名：`/dev/sda`
- SATA5 插槽上的文件名：`/dev/sdb`
- U盘 (启动完成后才被系统检测到)：`/dev/sdc`

### 2.2 磁碟的组成复习

磁盘的第一个扇区记录了整个磁盘的两个重要信息，分别是：

- 主要启动记录区 (Master Boot Record, MBR)：可以安装启动管理程序的地方，有 446 bytes
- 分区表 (partition table)：记录整个硬盘的分区状态，有 64 bytes

### 2.3 磁盘分区表 (partition table)

『开始与结束磁柱』是是分区的最小单位。在分区表所在的 64 bytes 容量中，总共分为四组记录区，
每组记录区记录了该区段的启始与结束的磁柱号码。

假设上面的硬盘装置档名为 `/dev/hda`，那么这四个分区的装置档名如下，
重点在於档名后面会再接一个数字，这个数字与该分区的位置相关：

- P1: `/dev/hda1`
- P2: `/dev/hda2`
- P3: `/dev/hda3`
- P4: `/dev/hda4`

由於分区表只有 64 bytes，最多只能容纳四个分区记录，这四个分区记录被称为主要 (Primary)
或扩展 (Extended) 分区。几个重点：

- 所谓的『分区』是针对那个 64 bytes 的分区表进行配置；
- 硬盘默认的分区表仅能写入四组分区记录
- 这四组分区记录我们称为主要 (Primary) 或扩展 (Extended) 分区
- 分区的最小单位为磁柱 (cylinder)
- 当系统要写入磁碟时，一定会参考磁盘分区表，才能针对某个分区进行数据的处理

分区原因：

1. 数据的安全性：每个分区的数据是分开的，可以独立格式化某个分区而不影响其他。
2. 系统的性能考量：当有数据要读取自某分区时，磁碟只会搜索对应柱面范围，且数据集中有助於提升数据
    读写性能。

分区表只有记录四组数据的空间，是否代表一颗硬盘最多只能分割出四个区？答案为否定。

扩展分区：利用额外的磁区来记录更多的分区信息，扩展分区本身并不能被拿来格式化。

由扩展分区分出来的被称为逻辑分区 (logical partition)。
由於逻辑分区是由扩展分区继续分割出来的，所以它可以使用的磁柱范围就是扩展分配所配置的范围。

1 主分区 + 1 扩展分区（包含 5 个逻辑分区），在 Linux 系统中的设备文件名如下：

- P1: `/dev/hda1`
- P2: `/dev/hda2`
- L1: `/dev/hda5`
- L2: `/dev/hda6`
- L3: `/dev/hda7`
- L4: `/dev/hda8`
- L5: `/dev/hda9`

因为前面四个号码都是保留给 Primary 或 Extended 用的，所以逻辑分区的名称号码就由 5 号开始。

主分区、扩展分区与逻辑分区：

- 主分区与扩展分区最多可以有四个 (硬盘的限制)；
- 扩展分区最多只能有一个 (操作系统的限制)；
- 逻辑分区是由扩展分区持续切割出来的；
- 能够被格式化后，作为数据存取的分区主分区与逻辑分区。扩展分区无法格式化；
- 逻辑分区的数量依操作系统而不同，在 Linux 系统中，IDE 硬盘最多有 59 个逻辑分割 (5 号到 63
  号)，SATA 硬盘则有 11 个逻辑分割 (5 号到 15 号)。

例题 1：在 Windows 操作系统当中，如果想要将 D 与 E 盘整合成为一个新的分区，
假设有两种分区如下，请问这两种方式是否均可将 D 与 E 整合成为一个新的分区？

1. 分区方式 1
  
    ```part1
    P | L (D) | L (E) | L | L | L |
    ```

2. 分区方式 2

    ```part2
    P | P (D) | L (E) | L | L | L |
    ```

答：方式 1 可以整合，因为上图的 D 与 E 同属扩展分区内的逻辑分区；方式 2 不可整合，因为 D 与
E 分属主分区与逻辑分区，两者不能够整合在一起。

如果硬盘的第一个扇区 (就是 MBR 与 partition table 所在的磁区) 物理实体坏掉了，
那这个硬盘大概就没有用了，因为系统找不到分区表，也就无法知道如何读取柱面区间。

例题 2：如果我想将一颗大硬盘『暂时』分割成为四个 partitions，
同时还有其他的剩余容量可以让我在未来的时候进行规划，我能不能分割出四个 Primary？若不行，
那么你建议该如何分割？

答：由於 Primary+Extended 最多只能有四个，其中 Extended 最多只能有一个，
这个例题想要分割出四个分割槽且还要预留剩余容量， 因此 P+P+P+P 的分割方式是不适合的。
假设你想要将所有的四笔记录都花光，那么 P+P+P+E 是比较适合的。所以可以用的四个 partitions 有
3 个主分区及一个逻辑分区，剩余的容量在扩展分区中。

例题：假如我的 PC 有两颗 SATA 硬盘，我想在第二颗硬盘分割出 6 个可用的分割槽
(可以被格式化来存取数据之用)，那每个分割槽在 Linux 系统下的装置档名为何？且分割类型各为何？
至少写出两种不同的分割方式。

答：

1. P+P+P+E：`/dev/sdb1`, `/dev/sdb2`, `/dev/sdb3`, `/dev/sdb5`, `/dev/sdb6`,
    `/dev/sdb7`。
2. P+E：`/dev/sdb1`, `/dev/sdb5`, `/dev/sdb6`, `/dev/sdb7`, `/dev/sdb8`,
    `/dev/sdb9`

### 2.4 启动流程与主要启动记录区(MBR)

在计算机启动的时候，会主动运行的第一个程序是 BIOS。BIOS 会依据配置去取得能够启动的硬盘，
并且到该硬盘里面去读取第一个磁区的 MBR 位置。MBR 这个仅有 446 bytes
的硬盘容量里面会放置最基本的启动管理程序，此时 BIOS 就功成圆满，接下来就是 MBR
内的启动管理程序的工作了。

这个启动管理程序的目的是加载 (load) 核心文件，由於启动管理程序是操作系统在安装的时候所提供的，
所以他会认识硬盘内的文件系统格式，因此就能够读取核心文件，然后接下来就是核心文件的工作，
启动管理程序也功成圆满，之后就是操作系统的任务了。

整个启动流程到操作系统之前的动作应该是这样的：

1. BIOS：启动主动运行的固件，识别第一个可启动的设备；
2. MBR：第一个可启动设备的第一个磁区内的主要启动记录区块，内含启动管理程序；
3. 启动管理程序 (boot loader)：一支可读取核心文件来运行的软件；
4. 核心文件：开始操作系统的功能...

BIOS 与 MBR 都是硬件本身支持的功能，至於 Boot loader 则是操作系统安装在 MBR
上面的一套软件。这个 boot loader 的主要任务有底下这些项目：

- 提供菜单：使用者可以选择不同的启动项目；
- 加载核心文件：直接指向可启动的程序区段来开始操作系统；
- 转交其他 loader：将启动管理功能转交给其他 loader 负责。

启动管理程序除了可以安装在 MBR 之外，还可以安装在每个主分区的启动磁区 (boot sector)。

MBR 的启动管理程序可以提供两个菜单，菜单一(M1) 可以直接加载 Windows 的核心文件来启动；
菜单二(M2) 则是将启动管理工作交给第二个分区启动磁区 (boot sector)。
当使用者在启动的时候选择菜单二时，那么整个启动管理工作就会交给第二分区的启动管理程序了。
当第二个启动管理程序启动后，该启动管理程序内仅有的一个启动菜单，因此就能够使用 Linux
的核心文件来启动。总结如下：

- 每个分区都拥有自己的启动磁区 (boot sector)；
- 系统分区为 MBR 的主分区（GPT 的主分区可以大于 4）；
- 实际可启动的核心文件放置在各主分区内；
- loader 只会认识自己的系统分区内的可启动核心文件，以及其他 loader；
- loader 可直接指向或者是间接将管理权转交给另一个 loader。

『如果要安装多重启动，最好先安装 Windows 再安装 Linux』，这是因为：

- Linux 在安装的时候，你可以选择将启动管理程序安装在 MBR 或别的分区的启动磁区，而且 Linux
  的 loader 可以手动配置菜单，所以你可以在 Linux 的 boot loader 里面加入 Windows
  启动的选项；
- Windows 在安装的时候会主动覆盖掉 MBR 以及自己所在分区的启动磁区，你没有选择的机会，
  而且它没有让我们自己选择菜单的功能。

因此，如果先安装 Linux 再安装 Windows，那 MBR 的启动管理程序就只会有 Windows 的项目，
而不会有 Linux 的项目。

### 2.5 Linux 安装模式下，磁盘分区的选择 (极重要)

- 目录树结构 (directory tree)

  所谓的目录树架构 (directory tree) 就是以根目录为主，
  然后向下呈现分支状的目录结构的一种文件架构。整个目录树架构最重要的就是那个根目录
  (root directory) `/`。所有的文件都是由根目录 (/) 衍生来的。

- 文件系统与目录树的关系 (挂载)

  所谓的『挂载』就是利用一个目录当成进入点，将磁盘分区的数据放置在该目录下；也就是说，
  进入该目录就可以读取该分区的意思。这个动作我们称为『挂载』，那个进入点的目录我们称为
  『挂载点』。由於整个 Linux 系统最重要的是根目录，因此根目录一定需要挂载到某个分区的。
  至於其他的目录则可依使用者自己的需求来给予挂载到不同的分区。

  例题：计算机系统如何读取光盘内的数据呢？在 Windows 里面使用的是『光驱』的代号方式处理
  (假设为 E 盘)，但在 Linux 底下依旧是使用目录树。在默认情况下，Linux 将光驱的数据放置到
  `/media/cdrom` 里。如果光盘片里面有个文件档名为『我的文件』时，那么这个文件是在哪里？

  答：

  - Windows：`E:\我的文件`
  - Linux：`/media/cdrom/我的文件`

- distributions 安装时，挂载点与磁盘分区的规划：
  - 自订安装『Custom』：
    - A：初次接触 Linux：只要分割『 / 』及『swap』即可：

      这样做不怕分割错误造成无法安装的困境！例如 `/usr` 是`Linux`
      的可运行程序及相关的文件摆放的目录，万一分割了一块分区给 `/usr`，但是给的不够大，
      那么就可能会造成无法将数据完全写入的问题。如果你是初次安装的话，那么可以仅分成两个分区，
      `/` 与 `Swap` 即可。

    - B：建议分割的方法：预留一个备用的剩余磁碟容量！

      预留的分区可以拿来做为备份之用。我们在实际操作Linux系统的过程中， 可能会发现某些
      script 或者是重要的文件很值得备份时，就可以使用这个剩余的容量分割出新的分区，
      并使用来备份重要的配置档或者是 script。这有个最大的好处，当需要重新安装的时候，
      这些软件或工具程序马上就可以直接在硬盘当中找到！

  - 选择 Linux 安装程序提供的默认硬盘分割方式：

    对於首次接触 Linux 的朋友，通常不建议使用各个 distribution 提供的默认安装方式，
    因为会让你无法得知 Linux 具体在做什么，而且也不见得可以符合你的需求。

## 3. 安装 Linux 前的规划

### 3.1 选择适当的 distribution

### 3.2 主机的服务规划与硬件的关系

- 打造 Windows 与 Linux 共存的环境；
- NAT (达成IP分享器的功能)；
- SAMBA (加入 Windows 网络上的芳邻)：Linux 上 SAMBA 可以加入 Windows 网芳。SAMBA
  的效能不错，也没有用户端连线数的限制，相当适合作为一般学校环境的文件服务器 (file server)；
- Mail (邮件服务器)：在 mail server 上，重要的是硬盘容量与网卡速度，这种情况可以将 `/var`
  目录独立出来，并加大容量；
- Web (WWW 服务器)；
- DHCP (提供用户端自动取得 IP 的功能)；
- Proxy (代理服务器)；
- FTP。

### 3.3 主机硬盘的主要规划 (partition)

硬盘数据的分类与数据安全性也需要注意。『数据安全』并不是指数据被 cracker 所破坏，而是指
『当主机系统的硬件出现问题时，你的文件数据能否安全地保存』。

硬盘基本的分区模式：

- 最简单的分割方法：仅分割出根目录 `/` 与内存置换空间 `swap`，
  再预留一些剩余的磁碟以供后续使用。不过，这是不保险的分割方法。因为如果任何一个小细节坏掉 (例如坏轨的产生)，你的根目录将可能整个损毁。
- 稍微麻烦一点的方式：先分析这部主机的未来用途，然后根据用途去分析需要较大容量的目录，
  以及读写较为频繁的目录，将这些重要的目录分别独立出来而不与根目录放在一起，
  当这些读写较频繁的磁盘分区有问题时，至少不会影响到根目录的系统数据。
  以下目录符合容量大且(或)读写频繁：
  - `/`
  - `/usr`
  - `/home`
  - `/var`
  - `Swap`

### 3.4 鸟哥说：关於练习机的安装建议

- 关於硬件方面：鸟哥『强烈的建议您，务必拥有一台独立的主机，而且内含一颗仅有 Linux
  操作系统的硬盘』。
- 关於硬盘分割方面：对于新手来说，先暂时以 `/` 及 `swap` 两个分割即可，
  并预留一个未分割的空间，用于未来的练习。
- 关於软件方面：『强烈的建议新手，务必将所有的套件都给他安装上去！』即选择『安装所有套件』。

### 3.5 鸟哥的两个实际案例

- 案例一：家用的小型 Linux 服务器，IP 分享与文件分享中心：
  - 提供服务：NAT、SAMBA 服务器；
  - 主机硬件配备：
    - CPU: P-III 800 MHz；
    - RAM: 512 MB；
    - 两张网络卡，控制芯片为 Realtek；
    - 共有两颗磁碟，一颗系统碟一颗数据碟。数据碟高达 160 GB；
    - 显卡为 GeForce 2 MX，含 32 MB 内存；
    - 安装完毕后将萤幕, 键盘, 鼠标, DVD-ROM 等配备均移除，仅剩下网络线与电源线。
  - 硬盘分割：
    - 分成 `/boot`, `/`, `/usr`, `/var`, `/tmp` 等目录均独立；
    - `/home` 独立出来，放置到那颗 160GB 的磁碟，提供给家庭成员存放个人数据；
    - 1 GB 的 Swap；
- 案例二：提供 Linux 的 PC 集群 (Cluster) 计算机群：
  - 提供服务：提供研究室成员对於模式模拟的软、硬件平台，主要提供研究室内部的研究工作分析。
  - 主机硬件配备：
    - 利用两部双 CPU (均为双核) 的 x86_64 系统；
    - Geforce 7300 显卡，含 64MB 内存；
    - 一颗硬盘作为主系统，六颗磁碟组成磁盘阵列，以储存模式模拟的结果；
    - 使用 PCI-Express 网卡，速度为 Gbps；
    - 4GB 主内存容量；
  - 硬盘分割：
    - 全部的磁盘阵列容量均给 /cluster/raid 目录，2TB 容量；
    - 2GB swap；
    - 分割出 `/`, `/usr`, `/var`, `/tmp` 等目录，避免程序错误造成系统的困扰；
    - `/home` 也独立出来，让每个研究室成员可以拥有自己的数据存放容量；

### 3.6 大硬盘配合旧主机造成的无法启动问题

某些比较旧的主板中，BIOS 可能识别不了大容量的硬盘。所以，在旧主板上面安装新的大容量磁碟时，
很可能你的磁碟容量会被误判！

不过，当 Linux 核心顺利启动启动后，他会重新再去侦测一次整个硬件而不理会 BIOS 所提供的资讯，
所以就能够顺利的捉到正确的硬盘，并且让你安装 Linux。

但是安装完毕后，可能会无法启动！因为 BIOS 捉到的硬盘是不对的，所以可能会出现无法启动的错误。

由於 BIOS 捉到的磁碟容量不对，但是至少在整颗磁碟前面的磁区它还读得到，因此，
只要将这个磁碟最前面的容量分割出一个小分割槽，并将这个分割槽与系统启动文件的放置目录摆在一起，
那就是 `/boot` 目录，就能够解决了。重点就是：『将启动磁区所在分区规范在小於 1024 个磁柱以内』
即可！在进行安装的时候，规划出三个磁区，分别是：

- `/boot`：100M Bytes左右即可，且放在整块硬盘的最前面
- `/`
- `swap`

## 4. 重点回顾

- 新添购计算机硬件配备时，需要考量的角度有『游戏机/工作机的考量』、『效能/价格比的考量』、
  『支持度的考量』等；
- 旧的硬件配备可能由於保存的问题或者是电子零件老化的问题，
  导致计算机系统非常容易在运行过程中出现不明的死机情况
- Red Hat 的硬件支持：<https://hardware.redhat.com/?pagename=hcl>
- 在 Linux 系统中，每个装置都被当成一个文件来对待，每个装置都会有装置档名。
- 磁碟的装置档名主要分为 (1) IDE介面的 `/dev/hd[a-d]` 及 (2) SATA/SCSI/U盘介面的
  `/dev/sd[a-p]` 两种；
- 磁碟的第一个磁区主要记录了两个重要的资讯，分别是：(1) 主要启动记录区 (Master Boot
  Record, MBR)：可以安装启动管理程序的地方，有 446 bytes；(2) 分割表
  (partition table)：记录整颗硬盘分割的状态，有64 bytes；
- 磁碟的主要与扩展分配最多可以有四个，逻辑分割的装置档名号码，一定由 5 号开始；
- 启动的流程由：BIOS --> MBR --> boot loader --> 核心文件；
- boot loader 的功能主要有：提供菜单、加载核心、转交控制权给其他 loader
- boot loader 可以安装的地点有两个，分别是 MBR 与 boot sector
- Linux 操作系统的文件使用目录树系统，与磁碟的对应需要有『挂载』的动作才行；
- 新手的简单分割，建议只要有 `/` 及 `swap` 两个分割槽即可

## 5. 本章习题

## 6. 参考数据与延伸阅读

## 7. 针对本文的建议

> <http://phorum.vbird.org/viewtopic.php?t=23874>
